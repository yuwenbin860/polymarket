# Polymarket 组合套利系统

## 项目圣经 v5.4

> **文档版本**: v5.4
> **当前状态**: v5.4 - Production Ready
> **创建日期**: 2026-01-08
> **所有开发决策应参照本文档执行。**
>
> 🆕 **v5.4 核心更新**：
> 1. **容器化部署 (Phase 9)**: 提供 `Dockerfile` 和 `docker-compose.yml`，封装 Python 环境与依赖，实现一键启动。
> 2. **进程管理**: 集成 `supervisord`，支持 Web UI (Streamlit) 和 Scanner Daemon 在同一容器内并发运行，具备自动重启能力。
> 3. **实时数据流 (Phase 8)**: 集成 Polymarket CLOB WebSocket (`/ws/market`)，实现亚秒级订单簿更新。
> 4. **Web UI 交互式看板 (Phase 7)**: 实现基于 Streamlit 的全功能仪表盘，集成套利雷达、PnL 分析及策略实验室。

---

# 目录

1. [项目概述](#1-项目概述)
2. [核心原则](#2-核心原则) ⭐ **v3.0 LLM三大场景**
3. [战略共识](#3-战略共识) ⭐ **v3.0 禁区策略+优先级重构**
4. [风险控制体系](#4-风险控制体系) ⭐ **v3.0 新增2类风险**
5. [套利策略详解](#5-套利策略详解) ⭐ **v3.0 新增4类策略**
6. [验证框架](#6-验证框架)
7. [技术架构](#7-技术架构)
8. [数据模型](#8-数据模型)
9. [核心算法](#9-核心算法)
10. [开发路线图](#10-开发路线图)
11. [运维与监控](#11-运维与监控)
12. [扩展计划](#12-扩展计划)
13. [真实案例复盘](#13-真实案例复盘) ⭐ **v3.0 新增**
14. [创意池](#14-创意池)
15. [附录](#15-附录) ⭐ **v3.0 行动清单+铸币销毁指南**

> 📊 **进度追踪**:
> - 工作计划和里程碑: [docs/WORK_PLAN.md](./WORK_PLAN.md)
> - 详细工作日志: [docs/PROGRESS.md](./PROGRESS.md)

---

# 1. 项目概述

## 1.1 项目定位

**Polymarket组合套利系统**是一个**机会发现与验证工具**，用于识别预测市场中因逻辑定价错误而产生的套利机会。

### 核心价值主张

| 传统方法 | 本系统方法 |
|----------|------------|
| 人工浏览市场寻找机会 | 自动化扫描数千市场 |
| 依赖直觉判断逻辑关系 | LLM辅助识别语义依赖 |
| 手动计算套利空间 | **年化收益率(APY)计算 + 成本精算** |
| 容易错过隐蔽机会 | **多维度验证 + 持续监控** |
| 忽视结算风险 | **预言机对齐检查 + 边界验证** |

### 目标用户

**主要用户**：具有一定技术能力、熟悉预测市场、追求稳健收益的个人交易者（散户）

**使用场景**：
- 每日定时扫描（主力）
- 重大事件前后集中扫描
- 持续监控模式（后期）

## 1.2 核心理念：超级雷达

> **核心定位**：本系统是一个"超级雷达"，不是"全自动交易机器人"

```
┌─────────────────────────────────────────────────────────────┐
│                    系统定位金字塔                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│         ┌───────────────┐                                   │
│         │   人工决策    │  ← 最终买卖决定权在人              │
│         └───────┬───────┘                                   │
│                 │                                           │
│         ┌───────┴───────┐                                   │
│         │   验证体系    │  ← LLM + 规则 + 人工复核           │
│         └───────┬───────┘                                   │
│                 │                                           │
│         ┌───────┴───────┐                                   │
│         │   APY计算器   │  ← 年化收益 > 无风险利率+溢价      │
│         └───────┬───────┘                                   │
│                 │                                           │
│         ┌───────┴───────┐                                   │
│         │  机会发现引擎  │  ← 语义分析 + 逻辑推理            │
│         └───────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**不要痴迷于全自动执行**。只要系统能做到：
1. ✅ 扫出机会
2. ✅ LLM 告诉你逻辑
3. ✅ 计算器告诉你：扣除 Gas、滑点，且考虑锁仓时间后，**年化回报是 20%+**
4. ✅ 然后你**手动去点**

**这就是散户的最优解。**

## 1.3 项目目标

### 短期目标（Phase 1-2）
- [x] 验证核心策略可行性
- [x] 构建MVP原型
- [x] 支持多种LLM提供商
- [x] **发现并人工验证至少 3 个真实套利机会** (CASE-001, 002, 003)
- [x] **实现完整验证框架（六层验证）**
- [x] **完成至少 5 次模拟执行跟踪**

### 中期目标（Phase 3-4）
- [x] 实现年化收益率（APY）计算器
- [x] 实现预言机对齐检查
- [x] 实现订单簿深度分析 (VWAP)
- [x] 实现实时通知系统 (Telegram/WeChat)
- [x] 实现半自动执行引擎 (Layer 6)
- [ ] 达到单月 3 次以上高价值（APY>30%）机会发现

### 长期目标（Phase 4+）
- [ ] 建立历史回测系统
- [ ] 接入 Myriad 等平台（评估后）
- [ ] 半自动化执行
- [ ] 资金规模达到 $5,000+

## 1.4 成功指标

| 指标 | Phase 2 | Phase 3 | Phase 4 |
|------|---------|---------|---------|
| 每周发现潜在机会数 | ≥3 | ≥5 | ≥10 |
| **五层验证通过率** | ≥30% | ≥50% | ≥70% |
| **APY ≥ 15% 的机会占比** | - | ≥50% | ≥70% |
| 模拟执行成功率 | ≥50% | ≥80% | ≥90% |
| 真实执行成功率 | - | ≥90% | ≥95% |
| **单次有效套利平均利润** | - | ≥$50 | ≥$100 |

## 1.5 项目边界

### 在范围内 ✅
- Polymarket 平台内的组合套利（**核心**）
- 完备集套利、包含关系套利、等价市场套利、区间套利
- 手动/半自动执行
- 语义相似度发现隐蔽机会
- **年化收益率评估**
- **预言机风险评估**

### 不在范围内 ❌
- 基于预测的方向性交易（不是套利）
- 高频毫秒级套利（需要专业基础设施）
- 做空策略（Polymarket 不支持原生做空）
- 杠杆交易
- 美国合规平台（Kalshi/PredictIt）- 需要美国身份
- **跨链套利**（摩擦成本过高，见风险分析）

## 1.6 核心理论框架：语义Alpha

> **核心洞察**：预测市场的Alpha主要来源于**语义非同质性（Semantic Non-Fungibility）**。

传统金融市场中，资产由ISIN代码精确定义。而在预测市场中，资产的本质是**自然语言命题**。
同一经济事件的风险敞口，往往分散在由不同自然语言描述、不同分辨率规则和不同预言机触发的多个合约中。

**语义非同质性带来的机会**：
1. **一价定律频繁失效**：数学上等价的合约（如"BTC>100k"与"BTC>99,999"）存在显著价差
2. **人类难以实时比价**：数千个市场的语义映射超出人类处理能力
3. **LLM具有天然优势**：大语言模型在语义理解和逻辑推理方面的能力正是突破口

**单调性违背频发**：在"阶梯行权价"市场中，高行权价合约的价格偶尔会高于低行权价合约，
直接违背概率论中的单调性原则，为自动化系统提供了**无风险套利空间**。

---

# 2. 核心原则

> 这些原则指导整个项目的开发和运营方式。

## 2.1 验证优先 (Verification First)

**原则**：不急于执行，先验证策略有效性和风险。

```
正确流程：
发现机会 → 五层验证 → APY评估 → 人工复核 → 小额测试 → 放大执行

错误流程：
发现机会 → 直接执行（危险！）
```

## 2.2 年化思维 (APY Mindset)

**原则**：任何套利机会必须以年化收益率评估，而非绝对利润率。

**示例**：
```
❌ 错误思维："这个机会有 3% 利润，不错！"

✅ 正确思维：
   - 绝对利润：3%
   - 锁仓时间：6 个月
   - 年化收益：3% × (365/180) = 6.1%
   - 无风险利率（USDC 理财）：~5%
   - 结论：不值得做，还不如存 USDC
```

**APY 阈值**：
- 最低可接受 APY：**15%**（无风险利率 5% + 风险溢价 10%）
- 理想 APY：**25%+**
- 优秀 APY：**50%+**

## 2.3 风控前置 (Risk First)

**原则**：风险评估优先于收益计算。

```
评估顺序：
1. 预言机风险 → 结算来源是否一致？
2. 时间风险 → 结算时间是否对齐？
3. 边界风险 → 边界条件如何处理？
4. 流动性风险 → 能否以预期价格成交？
5. 收益评估 → 扣除所有成本后的 APY
```

## 2.4 小步快跑 (Incremental Progress)

**原则**：将宏大目标拆分为小目标，每个小目标独立验证后再进行下一步。

**执行要点**：
- 每个小目标应该可以在 1-3 小时内完成验证
- 验证失败时及时调整方向，避免沉没成本
- **里程碑级完成** → 更新 `docs/WORK_PLAN.md`
- **明细级进度** → 记录 `docs/PROGRESS.md`

## 2.5 实证优先 (Evidence-First)

**原则**：先发现真实案例，再设计识别算法。

```
正确流程：
1. 人工发现真实案例 → 2. 验证确实是套利 → 3. 设计识别算法 → 4. 实现并测试

错误流程：
1. 设计理论模型 → 2. 实现算法 → 3. 希望能找到套利（可能找不到）
```

## 2.6 LLM 赋能但不依赖 (LLM Empowerment)

**原则**：LLM 辅助识别，规则验证，人工决策。

> 💡 **核心洞察**：LLM 应被视为"数字分析师"，而非"预言家"。**不是让 LLM 预测未来，而是让它分析规则和情绪**。

**LLM 的正确定位**：

| 任务 | LLM 作用 | 可靠性 |
|------|---------|--------|
| 识别市场逻辑关系 | 核心能力 | 中高（需验证） |
| **规则模糊度分析** | **核心能力** | **高** |
| **新闻情绪偏离分析** | **核心能力** | **中高** |
| **相关性挖掘** | **核心能力** | **中高** |
| 判断完备集完整性 | 辅助提示 | 中（需规则验证） |
| 分析结算规则差异 | 风险提示 | 中（需人工确认） |
| 阈值方向判断 | **不可靠** | 低（必须规则验证） |
| 数学计算 | **禁止** | 极低（必须代码计算） |

**核心教训**：相信 Python 的 `>` 运算符，不要完全相信 LLM 的推理！

### LLM 赋能三大场景

#### 场景1：规则模糊度检测（Rules Lawyer）

预测市场的纠纷 90% 源于规则不清。利用 LLM 提前识别高风险市场。

**Prompt 模板**：
```
你是一个精通合同法和逻辑学的专家。请阅读以下 Polymarket 市场的 Resolution Rules：

[粘贴规则文本]

请分析：
1. 该规则是否存在歧义？
2. 是否存在某种现实情况发生了，但根据规则却无法判定为 YES 的情况？
3. 请列出 3 个可能的边缘案例（Edge Cases）
4. 从 0 到 10 给该规则的"模糊性风险"打分

输出格式：
- 模糊性评分：X/10
- 主要歧义点：...
- 边缘案例：1. ... 2. ... 3. ...
```

**应用策略**：
- 模糊分 > 7：高概率产生纠纷，策略转向 UMA 博弈或放弃
- 模糊分 4-7：谨慎参与，关注社区讨论
- 模糊分 < 4：规则清晰，可正常套利

#### 场景2：新闻情绪与价格偏离度分析

市场价格往往滞后于突发新闻，或者对新闻反应过度。

**工作流**：
```python
# 概念性工作流（非实际代码）
1. 每 5 分钟抓取关于特定事件的 Google News 标题摘要
2. Prompt：
   "基于以下新闻，用 0-100% 的概率评估'[事件]'发生的可能性。
    只基于文本证据，不要猜测。
    [新闻摘要]"
3. 对比 LLM 输出的概率与 Polymarket 当前价格
4. 若偏离 > 20%，且新闻刚刚发布 → 买入信号
```

**注意事项**：
- LLM 评估仅作为参考信号
- 需要结合市场流动性判断
- 警惕"已经 Price In"的情况

#### 场景3：相关性挖掘（Combinatorial Analysis）

利用 LLM 的语义理解能力，发现逻辑相关但价格脱锚的市场对。

**Prompt 模板**：
```
我有以下两个预测市场：
1. [市场A问题]，当前价格：X%
2. [市场B问题]，当前价格：Y%

请分析：
1. 这两个事件是否存在逻辑关系？（包含、等价、互斥等）
2. 如果存在包含关系，历史上这种关系的一致性如何？
3. 当前价格差异是否合理？如果不合理，哪个被高估/低估？
```

**示例**：
- "Trump赢得普选票" vs "Trump赢得总统大选"
- 历史上共和党输普选但赢大选存在先例
- 但如果价差过大（如30% vs 60%），LLM 可以提醒注意异常

---

# 3. 战略共识

## 3.1 散户的真正优势

> **关键洞察**：散户的优势不是"语义理解"（机器人也能用 LLM），而是**愿意等待低频机会 + 人工深度验证**。

| 优势 | 说明 | 如何利用 |
|------|------|----------|
| **耐心等待** | 不需要高频，等待中低频机会 | 专注高确定性机会 |
| **深度验证** | 愿意花时间阅读结算规则 | 人工复核每个机会 |
| **灵活资金** | 小资金进入大机构忽略的市场 | 专注 $500-$5000 级别机会 |
| **无 KYC 限制** | 去中心化平台无身份验证 | Polymarket 直接参与 |
| **边界情况分析** | 能够理解复杂的结算条款 | LLM 辅助 + 人工确认 |

## 3.2 核心策略优先级

基于深度研究报告《语义Alpha》的评分和市场竞争格局分析，确定以下策略优先级：

| 策略 | 评分 | 门槛 | 机器人竞争 | **推荐指数** |
|------|------|------|------------|-------------|
| **单调性违背套利** | **10/10** | 数学验证 | 极低 | **S++** ⭐核心金矿 |
| **区间划分套利** | **9.5/10** | 数学验证 | 极低 | **S+** ⭐金矿 |
| **小众/长尾市场套利** | 9/10 | 领域知识 | 极低 | **S** ⭐金矿 |
| **语义套利/预言机博弈** | 7.5/10 | 规则分析 | 低 | **A+** |
| **包含关系套利** | 7.5/10 | LLM分析 | 低 | **A+** |
| **等价市场套利** | 7/10 | LLM分析 | 低 | **A** |
| **完备集套利** | 7/10 | 验证能力 | 低 | **A** |
| 事件驱动交易 | 6.5/10 | 信息速度 | 中 | **B** |
| 跨平台套利(Poly vs Kalshi) | 8/10 | 美国身份 | 低 | **A+**（有条件） |
| 同链跨平台套利 | 6/10 | 资金分配 | 中 | **B** |

> **S++级策略说明**：单调性违背套利是数学上最确定的套利类型（违背概率论公理），且在加密货币领域的阶梯行权价市场中频繁出现。

## 3.3 禁区策略（散户必须避开）

> ⚠️ **重要警告**：以下策略已被机器人/做市商完全垄断，散户参与必输。

### 原子级无风险套利（0.5/10分）❌

**定义**：利用同一市场内 YES+NO 价格短暂低于 $1 的订单簿错配进行套利。

**为什么必须避开**：
- 机会存在窗口期仅**毫秒级**
- 专业套利机器人直连 CLOB API，运行在靠近服务器的节点
- 散户通过前端 UI 操作延迟 2-5 秒，根本无法竞争
- 即使看到价差，点击时往往已被吃掉（幽灵流动性）

**结论**：这是算法的战场，人类没有任何胜算。

### 负风险自动再平衡（1/10分）❌

**定义**：在多选项市场中，当所有候选人 YES 价格总和低于 $1 时买入全部。

**为什么必须避开**：
- 做市商（如 Wintermute）全天候监控概率总和
- 一旦偏离 $1，算法自动调整
- 需要同时买入 N 个选项，操作复杂度极高
- 手动操作过程中价格早已变动，导致滑点损耗

**结论**：除非你是编写代码的高级量化交易员，否则这类机会只存在于理论计算中。

## 3.4 核心结论

**1. S级金矿：小众长尾市场 + 区间套利**

- **小众/长尾市场**：在机器人缺乏数据源的垂直领域，领域专家有绝对定价优势
- **区间/阈值套利**：用户经常算不清不同区间之间的加总关系，数学上最确定

**2. A级核心能力：语义套利 + 包含关系**

- 需要理解 "Trump wins" → "GOP wins" 这类逻辑
- LLM 的强项，机器人最难自动化

**3. 跨链套利不值得做**

跨链成本（桥费 + Gas + 时间）通常会吞噬 3-5% 的资金，除非套利空间 >10%，否则不值得。

**4. 跨平台套利（有条件推荐）**

- **Poly vs Kalshi**：需要美国身份，但护城河极高（资金通道分割）
- **替代方案探索**：同链跨平台（如 Polymarket vs Azuro 等 Polygon 平台）

## 3.5 市场微观结构理解

### 订单簿 vs 显示价格

**致命误区**：使用 API 返回的 `outcomePrices`（Mid Price / Last Price）进行套利计算。

```
你看到: yes_price = 0.50
实际盘口: Bid @ 0.48, Ask @ 0.52

你买入必须按 Ask (0.52) 买，不是 0.50

后果: 计算出 2% 利润，实际执行亏 4%
```

**正确做法**：
- 使用 CLOB API 获取真实订单簿
- 计算 VWAP（成交量加权平均价）
- 考虑你的资金量在订单簿上的滑点

### 流动性深度

仅看 Pool 的总流动性是不够的，需要检查 Order Book Depth：

```
问题：为了吃下 $500 的单子，滑点是多少？

公式：Effective_Price = (Price × Size + Slippage_Cost) / Size

示例：
- 目标金额：$500
- Best Ask：$0.50
- 订单簿深度：$200 @ 0.50, $300 @ 0.52, $500 @ 0.55
- 实际成本：200×0.50 + 300×0.52 = $256 for 500 shares
- 有效价格：$256/500 = $0.512（比 Best Ask 高 2.4%）
```

## 3.6 关于跨平台套利的审慎评估

### 跨链成本分析

以 $500 交易为例：

| 成本项 | 金额 | 占比 |
|--------|------|------|
| 跨链桥费用 | $5-15 | 1-3% |
| 源链 Gas | $0.5-2 | 0.1-0.4% |
| 目标链 Gas | $0.5-2 | 0.1-0.4% |
| **总摩擦成本** | **$6-19** | **1.2-3.8%** |

**结论**：除非套利空间 > 5%，且锁仓时间 < 1 个月（APY > 60%），否则跨链不值得。

### 跨链时间问题

```
跨链时间: 几分钟到半小时
套利窗口: 通常只有几秒到几分钟

结论: 除非在两个平台预存资金，否则无法捕捉机会
```

### 建议策略

| 策略 | 可行性 | 原因 |
|------|--------|------|
| Polymarket 内部组合套利 | ✅ 强烈推荐 | 同链，无跨链成本，原子化执行 |
| 同链跨平台套利 (Poly vs Azuro) | 🟡 谨慎 | 需评估 Gas 和流动性 |
| 跨链跨平台套利 | ❌ 仅限长窗口期 | 跨链成本占比过高 |

## 3.7 领域优先级（Market Domain Priority）

基于深度研究报告《语义Alpha》的分析，确定以下领域优先级：

| 领域 | 评级 | 技术难度 | 风险等级 | 说明 |
|------|------|----------|----------|------|
| **加密货币** | ⭐⭐⭐⭐⭐ | 低 | 低 | 规则多为数字比较，语义清晰，流动性最好，**首选领域** |
| 体育赛事 | ⭐⭐⭐⭐ | 中 | 中 | 规则相对标准，但需处理加时赛、延期等边缘情况 |
| 经济指标 | ⭐⭐⭐ | 中 | 中 | 需警惕数据修正（Revision）和舍入（Rounding）规则 |
| 政治选举 | ⭐⭐ | 高 | **极高** | 文本充满模糊词汇，UMA争议风险最大，**不建议完全自动化** |

**首选领域理由**：
- 加密货币市场的结算规则最清晰（"BTC价格是否突破100k"几乎没有歧义）
- 数据来源明确（币安、Coinbase等交易所价格）
- 市场流动性最好
- 阶梯行权价结构常见，单调性违背机会相对多

---

# 4. 风险控制体系

> **v2.0 核心升级**：风控从附属章节提升为核心章节，前置于策略详解。

## 4.1 五大致命风险

### 风险 1：预言机基差风险 (Oracle Basis Risk)

**问题**：两个看似逻辑相关的市场，可能使用不同的结算来源。

**致命场景**：
```
市场 A: "Trump wins 2024?" (结算来源: AP News)
市场 B: "GOP wins 2024?" (结算来源: Fox News)

看似 A → B，但：
- Fox News 宣布 Trump 赢了
- AP News 还没宣布
- B 结算为 YES，A 还在交易

后果：你的套利组合崩溃
```

**强制规则**：
```
只有当 Source 完全一致，或 Source A 的权威性/速度严格优于 Source B 时，
才能视为"硬套利"。否则降级为"软套利/基差交易"。
```

**验证清单**：
- [ ] 两市场结算来源是否相同？
- [ ] 如果不同，是否存在明确的权威性顺序？
- [ ] 历史上这两个来源是否有分歧案例？

### 风险 2：时间不一致风险 (Temporal Mismatch)

**问题**：LLM 容易忽略时间状语差异。

**致命场景**：
```
市场 A: "Bitcoin > 100k in 2024?" (结算: 2024-12-31 UTC)
市场 B: "Bitcoin > 100k by Jan 2025?" (结算: 2025-01-01 EST)

看似 B 包含 A，但时区差异可能导致：
- A 结算为 NO（2024年底未达到）
- B 结算为 YES（2025年1月1日达到）
```

**强制规则**：
```
蕴含关系 (A→B)：end_date(B) >= end_date(A)
完备集：所有市场的 end_date 差异 ≤ 24 小时
时区：统一转换为 UTC 后比较
```

### 风险 3：资金占用成本 (Cost of Carry)

**问题**：忽略锁仓时间的机会成本。

**致命场景**：
```
发现一个 3% 的包含关系套利机会，听起来不错。
但这两个事件都要在 6 个月后才结算。

本金锁定半年赚 3% = 年化 6%
USDC 无风险理财（Aave/Compound）= 4%-8%

结论：还不如存 USDC
```

**强制规则**：
```python
Expected_APY = (Profit / Cost) × (365 / Days_To_Resolution)

阈值：只有 Expected_APY > Risk_Free_Rate + Risk_Premium (≥15%) 才值得动手
```

**APY 速查表**：

| 绝对利润 | 锁仓 7 天 | 锁仓 30 天 | 锁仓 90 天 | 锁仓 180 天 |
|----------|-----------|------------|------------|-------------|
| 1% | 52% ✅ | 12% 🟡 | 4% ❌ | 2% ❌ |
| 2% | 104% ✅ | 24% ✅ | 8% ❌ | 4% ❌ |
| 3% | 156% ✅ | 36% ✅ | 12% 🟡 | 6% ❌ |
| 5% | 260% ✅ | 61% ✅ | 20% ✅ | 10% 🟡 |
| 10% | 521% ✅ | 122% ✅ | 41% ✅ | 20% ✅ |

✅ = 值得做（APY ≥ 15%）  
🟡 = 边缘（10% ≤ APY < 15%）  
❌ = 不值得（APY < 10%）

### 风险 4：CTF 代币机制风险 (Conditional Token Framework)

**问题**：Polymarket 基于 Gnosis CTF，多选项市场的代币机制复杂。

**致命场景**：
```
在多选项市场（比如"谁是共和党候选人"）：
买入 "No-Trump" 可能等同于持有 "Yes-DeSantis + Yes-Haley + ..." 的组合篮子

当你试图进行跨市场套利时：
- 如果涉及 Token Merge，Gas 费比普通 Swap 高 3-5 倍
- 这会吞噬掉小额套利的利润
```

**应对策略**：
- 理解目标市场的 Token 结构
- 计算 CTF 赎回 Gas（通常比普通 ERC20 转账贵）
- 小额套利（<$200）需特别注意 Gas 占比

### 风险 5：执行滑点风险 (Slippage Risk)

**问题**：订单簿深度不足导致实际成交价偏离预期。

**致命场景**：
```
你发现 3% 套利机会
你要买 $500 的单子
订单簿深度：Best Ask 后只有 $100

实际情况：
- $100 @ 0.50 (Best Ask)
- $200 @ 0.53
- $200 @ 0.56

你的加权成交价：(100×0.50 + 200×0.53 + 200×0.56) / 500 = $0.536

滑点成本：(0.536 - 0.50) / 0.50 = 7.2%

结果：3% 利润被 7.2% 滑点吃掉，净亏损 4.2%
```

**强制规则**：
- 必须通过 CLOB API 获取订单簿
- 计算目标金额的 VWAP
- 用 VWAP 而非 Best Ask 计算套利空间

## 4.2 风险矩阵

| 风险类型 | 可能性 | 影响 | 风险等级 | 缓解措施 |
|----------|--------|------|----------|----------|
| **预言机基差** | 中 | 极高 | 🔴**致命** | 强制 Oracle 对齐检查 |
| **时间不一致** | 中 | 高 | 🔴高 | 统一 UTC 时间验证 |
| **规则定义分歧** | 中 | 极高 | 🔴**致命** | 逐字比对 Resolution Rules |
| **UMA投票操纵** | 低 | 高 | 🟡中 | 监控大户动向 |
| **资金占用成本** | 高 | 中 | 🟠中高 | APY 计算器强制过滤 |
| 逻辑关系误判 | 中 | 高 | 🔴高 | 五层验证 + 人工复核 |
| 执行滑点 | 中 | 中 | 🟡中 | 订单簿深度检查 |
| CTF 机制成本 | 低 | 中 | 🟢低 | Gas 预估纳入成本 |
| 流动性不足 | 中 | 中 | 🟡中 | 最小流动性阈值 |
| API 变更 | 低 | 低 | 🟢低 | 版本监控、及时适配 |
| 平台风险 | 低 | 高 | 🟡中 | 不存大额、及时提现 |

### 风险 6：规则定义分歧风险 🆕

**问题**：跨平台套利时，不同平台对同一事件的定义可能不同。

**致命场景**：
```
Polymarket: "TikTok 被禁" = 总统签署禁令法案
Kalshi:     "TikTok 被禁" = App Store 下架

可能发生：
- 总统签署法案（Polymarket YES）
- 但法院暂缓执行，App 仍可下载（Kalshi NO）

后果：你的套利组合两边都输
```

**强制规则**：
```
跨平台套利必须：
1. 逐字比对两平台的 Resolution Rules
2. 使用 LLM 分析规则差异
3. 识别所有可能导致"双输"的场景
4. 仅在规则实质等价时才执行
```

### 风险 7：UMA 投票操纵风险 🆕

**问题**：UMA 预言机依赖代币持有者投票，可能被操纵。

**机制**：
```
UMA 投票机制：
- 代币持有者质押 UMA 后参与投票
- 多数票决定结算结果
- 大户（Whales）可能拥有显著投票权
```

**操纵场景**：
- 大户在争议期通过借贷协议借入大量 UMA 代币
- 用借来的代币操纵投票结果
- 投完票后归还代币，获取不当利益

**应对策略**：
1. 监控 Dispute 期间 UMA 代币大额转移
2. 关注 UMA Discord 社区讨论
3. 识别历史上有争议判决记录的大户
4. 对高风险市场降低仓位或放弃

## 4.3 仓位管理规则

```python
# 风控参数
MAX_SINGLE_POSITION = 0.10      # 单笔最大仓位（占总资金）
MAX_DAILY_EXPOSURE = 0.30       # 日最大敞口
MAX_EVENT_EXPOSURE = 0.20       # 单事件最大敞口
MIN_LIQUIDITY_RATIO = 0.10      # 仓位不超过市场流动性的 10%
MIN_APY = 0.15                  # 最低年化收益率阈值
MAX_DAYS_TO_RESOLUTION = 180    # 最长锁仓天数
```

## 4.4 止损与退出规则

| 情况 | 行动 |
|------|------|
| 发现预言机来源不一致 | 立即平仓，不等结算 |
| 市场规则变更 | 评估影响，必要时平仓 |
| 单边亏损超过预期 | 检查是否逻辑判断错误 |
| 锁仓时间显著延长 | 重新计算 APY，决定是否退出 |

---

# 5. 套利策略详解

## 5.1 策略总览

```
┌─────────────────────────────────────────────────────────────┐
│                    套利策略分类                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  完备集套利   │  │ 包含关系套利  │  │ 等价市场套利  │      │
│  │  Σ(YES) < 1  │  │ P(B) < P(A)  │  │ |ΔP| > ε    │      │
│  │  买全部YES   │  │ 买B-YES+A-NO │  │ 买低卖高     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  区间套利    │  │  时序套利    │  │  跨平台套利   │      │
│  │ 互补区间<1   │  │ 累积概率关系 │  │  同事件跨平台 │      │
│  │ 买互补区间   │  │   (新增)    │  │  (谨慎评估)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 5.2 完备集套利 (Exhaustive Set Arbitrage)

### 定义
一组互斥且覆盖所有可能结果的市场，其 YES 价格总和应该等于 $1.00。

### 套利条件
```
Σ(YES价格) < $1.00 - 交易成本
```

### 数学原理
```
设有 n 个互斥且完备的结果: O₁, O₂, ..., Oₙ
约束: P(O₁) + P(O₂) + ... + P(Oₙ) = 1

如果市场定价: p₁ + p₂ + ... + pₙ < 1
则存在套利机会

操作: 买入所有选项各一份
成本: Σpᵢ < 1
回报: 1.00（无论哪个结果发生）
利润: 1.00 - Σpᵢ
```

### 示例
```
事件：2028年美国大选结果

市场1: "共和党获270-299选举人票"  YES = $0.18
市场2: "共和党获300-319选举人票"  YES = $0.12
市场3: "共和党获320+选举人票"     YES = $0.05
市场4: "民主党获胜"              YES = $0.58
─────────────────────────────────────────────
总计: $0.93

操作: 各买一份，成本 $0.93，必得 $1.00
绝对利润: $0.07 (7.5%)
假设结算时间: 30 天后
APY: 7.5% × (365/30) = 91% ✅
```

### 关键验证点
- [ ] 这些选项真的互斥吗？
- [ ] 这些选项覆盖了所有可能吗？
- [ ] 结算规则是否一致（同一来源）？
- [ ] 是否有遗漏的选项？
- [ ] **所有市场属于同一 Event ID？**

## 5.3 包含关系套利 (Implication Arbitrage)

### 定义
如果事件 A 发生必然导致事件 B 发生（A → B），那么 P(B) ≥ P(A)。

### 套利条件
```
P(B) < P(A) - ε（ε 为交易成本）
```

### 数学原理
```
逻辑关系: A → B（A 蕴含 B）
概率约束: P(B) ≥ P(A)

如果市场定价违反此约束: P(B) < P(A)
则存在套利机会

操作: 
- 买 B 的 YES @ P(B)
- 买 A 的 NO @ (1-P(A))

成本: P(B) + (1-P(A))
回报分析:
  - 若 A 发生（则 B 必发生）: B-YES=1, A-NO=0, 回报=1
  - 若 A 不发生且 B 发生: B-YES=1, A-NO=1, 回报=2
  - 若 A 不发生且 B 不发生: B-YES=0, A-NO=1, 回报=1

最小回报: 1.00
利润: 1.00 - 成本
```

### 示例
```
逻辑关系: "特朗普赢" → "共和党赢"（因为特朗普是共和党候选人）

市场A: "特朗普赢得2028总统"     YES = $0.55
市场B: "共和党赢得2028总统"     YES = $0.50  ← 违反逻辑！

操作:
- 买 "共和党赢" YES @ $0.50
- 买 "特朗普赢" NO @ $0.45
成本: $0.95

结果分析:
┌─────────────────┬───────────┬───────────┬────────┐
│ 实际结果         │ 共和党YES │ 特朗普NO  │ 收入   │
├─────────────────┼───────────┼───────────┼────────┤
│ 特朗普赢        │ $1.00     │ $0.00     │ $1.00  │
│ 其他共和党人赢   │ $1.00     │ $1.00     │ $2.00  │
│ 民主党赢        │ $0.00     │ $1.00     │ $1.00  │
└─────────────────┴───────────┴───────────┴────────┘

无论结果如何，至少收入 $1.00，利润 ≥ $0.05 (5.3%)
```

### 常见包含关系模式

| 模式 | 包含方向 | 示例 |
|------|----------|------|
| 个人→政党 | 候选人赢 → 政党赢 | Trump赢 → GOP赢 |
| 夺冠→季后赛 | 夺冠 → 进季后赛 | Lakers夺冠 → Lakers进季后赛 |
| 高阈值→低阈值 | BTC>150k → BTC>100k | 上涨方向，更高蕴含更低 |
| 低阈值→高阈值 | 跌到$50 → 跌到$100 | **下跌方向，更低蕴含更高** |
| 时间包含 | 年内发生 → 半年内发生 | **注意：包含关系是反的** |

### ⚠️ 阈值方向的致命陷阱

**上涨阈值和下跌阈值的蕴含方向相反！**

```
上涨阈值: BTC 突破 $150k → BTC 突破 $100k
         (更高阈值蕴含更低阈值)

下跌阈值: Google 跌到 $50 → Google 跌到 $100
         (更低阈值蕴含更高阈值)
```

**LLM 经常搞错这个方向，必须用规则验证！**

## 5.4 等价市场套利 (Equivalent Market Arbitrage)

### 定义
两个市场本质上问的是同一个问题，只是表述不同。

### 套利条件
```
|P(A) - P(B)| > ε
```

### 示例
```
市场A: "Will Trump win the 2024 election?"    YES = $0.52
市场B: "Trump victory November 2024?"         YES = $0.48

价差: 4%

操作:
- 买低价市场 YES @ $0.48
- 买高价市场 NO @ $0.48
成本: $0.96

回报: $1.00（两个市场结果必然相同）
利润: $0.04 (4.2%)
```

### 关键验证点
- [ ] 两市场真的问的是同一件事？
- [ ] 结算来源是否相同？
- [ ] 结算时间是否相同？
- [ ] 措辞差异是否可能导致结算分歧？

## 5.5 区间套利 (Interval Arbitrage) ⭐ 金矿

### 定义
利用价格区间市场的互补关系进行套利。当两个区间的并集覆盖所有可能值且互斥时，买入两个区间的 YES 可以保证至少一个赢。

### 套利条件
```
P(A) + P(B) < $1.00 - ε（A 和 B 是互补区间）
```

### 真实案例
```
事件1: "Solana price on January 4?" (完备集事件)
  ├─ 市场A1: "Solana < 100 on Jan 4?"    YES = 1.0c
  ├─ 市场A2: "Solana 100-120 on Jan 4?"  YES = 2.0c
  ├─ 市场A3: "Solana 120-130 on Jan 4?"  YES = 1.6c
  └─ 所有 <130 区间 YES 总和 = 4.6c

事件2: "Solana above 130 on Jan 4?"
  ├─ YES = 94.8c
  └─ NO  = 5.2c

套利分析：
- 区间A: [0, 130) 完备集子市场 → 总价格 = 4.6c
- 区间B: [130, ∞) 阈值市场 → YES价格 = 94.8c
- 两个区间形成互补关系：覆盖所有可能的价格空间
- 套利操作：
  - 买区间A所有子市场的YES (4.6c)
  - 买区间B的YES (94.8c)
  - 总成本 = 99.4c
  - 保证回报 = $1.00
  - 利润 = 0.6c (0.6%)

假设结算时间: 3 天后
APY: 0.6% × (365/3) = 73% ✅
```

### 区间套利类型

| 类型 | 示例 | 互补关系 |
|------|------|----------|
| below + above | "<100" + "≥100" | 互补 ✅ |
| below + above | "<130" + ">130" | **有缺口** (=130) ⚠️ |
| range + above | "[0,130]" + ">130" | 互补 ✅ |
| range + range | "[0,100]" + "(100,200]" + ">200" | 三段互补 ✅ |

### 风险因素
- ⚠️ **边界值处理**：恰好等于阈值时如何结算？需查看具体规则
- ⚠️ **区间缺口**：如 "<130" 和 ">130" 在 =130 处有缺口
- ⚠️ **完备集验证**：需要确认区间确实覆盖所有可能值
- ⚠️ **结算一致性**：所有子市场的结算来源和规则必须一致

## 5.6 时序套利 (Temporal Sequence Arbitrage) 🆕

### 定义
利用时间累积概率关系进行套利。

### 逻辑关系
```
"BTC 在 1月突破 100k" (A) vs "BTC 在 2月突破 100k" (B)

如果 A 发生了，B 通常也会被视为发生（取决于具体措辞）
这是一个累积概率问题，比简单的 Subset 更微妙
```

### 关键验证点
- [ ] 措辞是 "by" 还是 "in"？
  - "by Feb" = 累积，包含之前所有月份
  - "in Feb" = 仅限 2 月
- [ ] 结算规则如何处理"已经发生"的情况？
- [ ] 是否有提前结算机制？

## 5.7 小众/长尾市场套利（9/10分）⭐ 金矿

### 定义

在机器人缺乏数据源的垂直领域，利用专业知识获得定价优势。机器人因缺乏训练数据和实时信息源，往往不敢深度介入或点差极大，这正是散户的"主场"。

### 套利逻辑

```
大众定价 = 媒体炒作 + 情绪驱动
专家定价 = 专业分析 + 证据支撑

当两者差距显著时 → 套利机会
```

### 适用领域

| 领域 | 市场类型 | 信息优势来源 |
|------|----------|--------------|
| **科学研究** | 室温超导、核聚变突破 | 论文解读、实验复现 |
| **航天** | SpaceX发射任务、星链部署 | 硬核论坛、基地监控 |
| **FDA药物** | 药物批准时间 | 临床数据、审批流程 |
| **AI模型** | GPT-5发布时间 | 技术社区、内部动态 |
| **流行文化** | 动漫销量、电影票房 | 粉丝社区、预售数据 |

### 操作策略

**策略1：专家红利**
- 利用专业知识识别被高估/低估的结果
- 在大众恐慌或狂热时反向操作
- 示例：LK-99 事件中物理学家卖出 YES

**策略2：做市商角色**
- 在流动性断层市场（Spread > 10%）充当做市商
- 挂单在买一卖一中间，吃两边点差
- 赚取大众非理性情绪的溢价

### 风险因素
- ⚠️ 流动性可能极低，大额操作困难
- ⚠️ 需要持续跟踪领域动态
- ⚠️ 结算可能延迟或规则模糊

## 5.8 语义套利与预言机博弈（7.5/10分）

### 定义

利用规则模糊性和 UMA 预言机机制进行博弈。预测市场的核心风险不在于事件本身，而在于**谁来判定事件的结果**。

### 核心场景

**场景1：模糊性溢价（Ambiguity Premium）**

当现实情况处于"灰色地带"时，市场价格会剧烈波动，恐慌性抛售创造出巨大的期望值偏离。

```
模糊性触发 → 恐慌抛售 → 价格偏离真实概率 → 套利机会
```

**场景2：UMA争议期套利**

当市场进入 "Dispute"（争议）阶段时：
1. 交易暂停或流动性枯竭
2. 如能提前预判 UMA 投票结果
3. 可在争议解决后的瞬间操作获利

**场景3：官方vs预言机分歧**

极少数情况下，Polymarket 会推翻 UMA 决议进行退款或重新裁决。熟悉治理流程的玩家可以捕捉这种不对称机会。

### UMA 博弈实操流程

```
1. 潜伏社区
   └─ 加入 UMA Protocol Discord
   └─ 加入 Polymarket Discord
   └─ 关注 #voting-discussion 频道

2. 监控大户动向
   └─ Etherscan/Polygonscan 监控 UMA 代币大额转移
   └─ 大户在争议期大量质押 = 准备介入投票

3. 规则文本分析
   └─ 逐字阅读 Resolution Source 和 Rules
   └─ 利用 LLM 分析边界情况
   └─ 寻找可能的解读分歧

4. 决策执行
   └─ 当官方判断与大户倾向分歧时
   └─ 买入被错杀方（可能 10x 收益）
```

### 关键验证点
- [ ] 结算规则是否存在歧义？
- [ ] UMA 社区讨论倾向如何？
- [ ] 历史上类似争议的判决先例？
- [ ] 大户投票权分布如何？

## 5.9 跨平台套利（8/10分）- 参考策略

> 📌 **注意**：此策略需要美国身份（Kalshi KYC），作为参考保留，并探索替代方案。

### 定义

利用不同平台的用户群体认知偏差和资金通道分割进行套利。

### Polymarket vs Kalshi 对比

| 维度 | Polymarket | Kalshi |
|------|------------|--------|
| **用户群** | 全球加密原生用户 | 仅限美国居民 |
| **资金通道** | USDC (Polygon) | USD (ACH银行转账) |
| **监管状态** | 离岸运营 | CFTC 完全合规 |
| **用户偏好** | 偏右翼、风险偏好高 | 相对保守 |

### 套利原理

```
资金无法在 USDC 和 USD 之间瞬间无损划转
→ 机器人难以抹平两个市场的价差
→ 存在分钟级甚至天级的套利窗口
```

### 替代方案探索

对于无美国身份的用户，可探索：

1. **同链跨平台**：Polymarket vs Azuro（均在 Polygon）
2. **同平台流动性池差异**：不同子市场的价差
3. **去中心化平台间套利**：无 KYC 限制的预测市场

### 风险因素
- ⚠️ **规则差异风险**：必须逐字比对两平台的 Resolution Rules
  - 示例：TikTok"禁令"在 Poly = 总统签署法案，Kalshi = App Store 下架
- ⚠️ **资金占用**：需要在两个平台预存资金
- ⚠️ **锁仓时间**：长期事件的 APY 可能不划算

## 5.10 事件驱动交易（6.5/10分）

### 定义

利用重大新闻发布后市场价格的滞后反应进行交易。

### 适用场景

- 美联储利率决议公布后
- 重大政治事件（选举结果、条约签署）
- 科技公司重大公告
- 法院判决

### 时间窗口

```
新闻发布 → 散户反应（10-30分钟）→ 价格调整
```

不同人群对新闻的反应速度和解读倾向不同，价差通常在新闻发布后的 10-30 分钟内拉大。

### LLM辅助流程

```python
# 概念性工作流
1. 定时抓取目标事件相关新闻
2. LLM 分析新闻内容，评估事件概率
3. 对比 LLM 评估与当前市场价格
4. 当偏离 > 20% 时触发信号
```

### 风险因素
- ⚠️ 反应速度仍慢于专业机构
- ⚠️ 新闻解读可能有偏差
- ⚠️ 市场可能已经"Price In"

## 5.11 单调性违背套利 (Monotonicity Violation Arbitrage) ⭐ 核心金矿

> **v3.0 新增** - 基于《语义Alpha》深度研究报告

### 理论基础

对于标量变量 X（如比特币价格、选举票数），其累积分布函数必须是**单调非减**的。

**数学表述**：
- 定义事件 E_k 为 "X > k"
- 对于任意两个阈值 k_1 < k_2，必然有：E_{k_2} ⟹ E_{k_1}
- 因此：P(X > k_1) ≥ P(X > k_2)

### 套利条件

当市场出现**价格倒挂**：
```
Price(X > k_high) > Price(X > k_low)  （其中 k_high > k_low）
```

这隐含了 P(k_low < X ≤ k_high) < 0，在数学上是**不可能的**，构成无风险套利。

### 操作策略

| 操作 | 说明 |
|------|------|
| 卖出 k_high 合约 | Short YES / Buy NO |
| 买入 k_low 合约 | Long YES |
| **结果保证** | 无论X落在哪个区间，组合收益均非负 |

### 真实案例模板

```
场景：BTC 12月价格阶梯市场

- 合约A："BTC > 95,000"  @ 90%
- 合约B："BTC > 100,000" @ 85%
- 合约C："BTC > 105,000" @ 86% ← 异常！

违背分析：
- C 的价格（86%）> B 的价格（85%）
- 但 BTC > 105k 必然意味着 BTC > 100k
- 价格倒挂 = 无风险套利机会

套利操作：
- 卖出 C 的 YES（或买 NO）@ 14%
- 买入 B 的 YES @ 85%
- 成本：85% + 14% = 99%
- 保证回报：100%（至少一个合约赢）
- 利润：1%

假设结算时间：7天
APY：1% × (365/7) = 52%
```

### 检测算法

```python
def detect_monotonicity_violation(markets: List[Market], asset: str):
    """检测同一资产、同一到期日的阈值型市场的单调性违背"""

    # 1. 筛选同一资产的阈值市场
    threshold_markets = [m for m in markets
                         if is_threshold_market(m) and m.asset == asset]

    # 2. 按阈值从小到大排序
    sorted_markets = sorted(threshold_markets, key=lambda m: m.threshold_value)

    # 3. 遍历检查单调性
    violations = []
    for i in range(len(sorted_markets) - 1):
        low = sorted_markets[i]
        high = sorted_markets[i + 1]

        # 上涨阈值：高阈值价格应该 <= 低阈值价格
        if low.direction == "above":
            if high.yes_price > low.yes_price + FEE_THRESHOLD:
                violations.append({
                    "type": "MONOTONICITY_VIOLATION",
                    "low_market": low,
                    "high_market": high,
                    "price_inversion": high.yes_price - low.yes_price
                })

    return violations
```

### 风险因素

- ⚠️ **边界值处理**：恰好等于阈值时如何结算？需查看具体规则
- ⚠️ **预言机一致性**：确保两个合约使用相同的数据源（如都用Binance收盘价）
- ⚠️ **时间一致性**：确保结算时间点完全一致
- ⚠️ **舍入规则**：价格四舍五入可能导致边界情况

---

# 6. 验证框架

> **v2.0 核心新增**：建立系统化的五层验证体系

## 6.1 六层验证架构 (v3.6 升级)

```
┌─────────────────────────────────────────────────────────────┐
│                    六层验证架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Layer 6: 执行前价格确认 (Pre-flight Check)                 │
│  └─ 下单瞬间抓取最新订单簿，验证利润是否依然存在              │
│                                                             │
│  Layer 5: 人工复核清单 (Human Review)                       │
│  └─ 生成 Markdown 复核报告，最终决策执行方向                 │
│                                                             │
│  Layer 4: APY 收益评估 (Yield Validation)                  │
│  └─ 年化收益率 ≥ 15%？评估锁仓期间的时间成本                 │
│                                                             │
│  Layer 3: 数学验证 (精算层)                                 │
│  └─ 基于 VWAP 的真实利润计算、滑点损耗、Gas 成本             │
│                                                             │
│  Layer 2: 规则一致性 (Rule Validation)                     │
│  └─ Oracle 对齐、时间戳 UTC 校验、阈值逻辑闭环               │
│                                                             │
│  Layer 1: LLM 语义识别 (Discovery)                         │
│  └─ 语义聚类、批量逻辑分析、跨市场蕴含与等价发现              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 6.2 Layer 1: LLM 关系识别

### 输入
- 两个市场的完整信息（问题、描述、价格、结算来源）

### 输出
```json
{
  "relationship": "IMPLIES_AB | IMPLIES_BA | EQUIVALENT | ...",
  "confidence": 0.0-1.0,
  "reasoning": "分析理由",
  "edge_cases": ["边界情况1", "边界情况2"],
  "resolution_compatible": true/false
}
```

### 验证规则
- 置信度 ≥ 0.8 才进入下一层
- edge_cases 不为空时需特别关注
- resolution_compatible 为 false 时直接拒绝

## 6.3 Layer 2: 规则验证

### 2.1 Oracle 对齐检查

```python
def check_oracle_alignment(market_a, market_b):
    """
    检查两个市场的结算来源是否对齐
    
    返回:
    - ALIGNED: 完全一致
    - COMPATIBLE: 兼容（一个是另一个的权威来源）
    - MISALIGNED: 不一致，降级为基差交易
    """
    source_a = extract_resolution_source(market_a)
    source_b = extract_resolution_source(market_b)
    
    if source_a == source_b:
        return "ALIGNED"
    
    # 权威性排序（示例）
    authority_order = [
        "Official Government Source",
        "AP News",
        "Reuters",
        "Major News Networks",
        "Fox News",  # 可能有偏差
    ]
    
    # 检查兼容性...
```

### 2.2 时间一致性检查

```python
def check_temporal_consistency(market_a, market_b, relationship):
    """
    检查时间一致性
    
    规则:
    - 蕴含关系 (A→B): end_date(B) >= end_date(A)
    - 完备集: 所有市场的 end_date 差异 ≤ 24 小时
    """
    # 统一转换为 UTC
    end_a = parse_to_utc(market_a.end_date)
    end_b = parse_to_utc(market_b.end_date)
    
    if relationship in ["IMPLIES_AB", "IMPLIES_BA"]:
        # 被蕴含方的结算时间必须 >= 蕴含方
        if relationship == "IMPLIES_AB":
            return end_b >= end_a
        else:
            return end_a >= end_b
    
    # 完备集/等价市场
    return abs((end_a - end_b).days) <= 1
```

### 2.3 阈值方向验证

```python
def validate_threshold_direction(market_a, market_b, relationship):
    """
    验证阈值类市场的蕴含方向是否正确
    
    规则:
    - 上涨(above/hit/突破): 更高阈值 → 更低阈值
    - 下跌(dip/below/跌到): 更低阈值 → 更高阈值
    """
    info_a = extract_threshold_info(market_a.question)
    info_b = extract_threshold_info(market_b.question)
    
    if not info_a or not info_b:
        return "SKIPPED"  # 不是阈值市场
    
    if info_a["type"] == "above" and info_b["type"] == "above":
        # 上涨: 更高阈值 → 更低阈值
        if relationship == "IMPLIES_AB":
            return info_a["value"] >= info_b["value"]
        elif relationship == "IMPLIES_BA":
            return info_b["value"] >= info_a["value"]
    
    elif info_a["type"] == "below" and info_b["type"] == "below":
        # 下跌: 更低阈值 → 更高阈值
        if relationship == "IMPLIES_AB":
            return info_a["value"] <= info_b["value"]
        elif relationship == "IMPLIES_BA":
            return info_b["value"] <= info_a["value"]
    
    return "SKIPPED"
```

## 6.4 Layer 3: 数学验证

### 3.1 利润计算（使用真实订单簿价格）

```python
def calculate_profit(markets, relationship, target_size_usd=500):
    """
    计算真实利润（考虑滑点）
    """
    # 获取订单簿
    order_books = [get_order_book(m.id) for m in markets]
    
    # 计算有效价格（VWAP）
    effective_prices = [
        calculate_vwap(ob, target_size_usd) 
        for ob in order_books
    ]
    
    # 根据套利类型计算
    if relationship == "EXHAUSTIVE":
        total_cost = sum(ep["ask_vwap"] for ep in effective_prices)
        profit = 1.0 - total_cost
        
    elif relationship in ["IMPLIES_AB", "IMPLIES_BA"]:
        # 买被蕴含方 YES + 买蕴含方 NO
        implied_idx = 1 if relationship == "IMPLIES_AB" else 0
        implying_idx = 1 - implied_idx
        
        cost = (effective_prices[implied_idx]["ask_vwap"] + 
                (1 - effective_prices[implying_idx]["bid_vwap"]))
        profit = 1.0 - cost
    
    return {
        "gross_profit": profit,
        "mid_price_profit": calculate_mid_price_profit(markets, relationship),
        "slippage_cost": calculate_slippage(effective_prices),
    }
```

### 3.2 VWAP 计算

```python
def calculate_vwap(order_book, target_size_usd):
    """
    计算成交量加权平均价格
    """
    asks = sorted(order_book['asks'], key=lambda x: float(x['price']))
    
    total_cost = 0.0
    total_shares = 0.0
    remaining_usd = target_size_usd
    
    for ask in asks:
        price = float(ask['price'])
        size = float(ask['size'])
        cost = price * size
        
        if remaining_usd <= 0:
            break
            
        if cost <= remaining_usd:
            total_cost += cost
            total_shares += size
            remaining_usd -= cost
        else:
            shares_needed = remaining_usd / price
            total_cost += remaining_usd
            total_shares += shares_needed
            remaining_usd = 0
    
    if remaining_usd > 0:
        return {"ask_vwap": float('inf'), "insufficient_liquidity": True}
    
    return {"ask_vwap": total_cost / total_shares, "insufficient_liquidity": False}
```

## 6.5 Layer 4: APY 验证

```python
def calculate_apy(profit_pct, days_to_resolution):
    """
    计算年化收益率
    
    公式: APY = (Profit / Cost) × (365 / Days)
    """
    if days_to_resolution <= 0:
        return float('inf')
    
    return profit_pct * (365 / days_to_resolution)

def validate_apy(opportunity):
    """
    验证 APY 是否满足阈值
    """
    MIN_APY = 0.15  # 15%
    MAX_DAYS = 180  # 最长锁仓天数
    
    apy = calculate_apy(
        opportunity.profit_pct, 
        opportunity.days_to_resolution
    )
    
    if opportunity.days_to_resolution > MAX_DAYS:
        return {
            "passed": False,
            "reason": f"锁仓时间过长: {opportunity.days_to_resolution} 天 > {MAX_DAYS} 天"
        }
    
    if apy < MIN_APY:
        return {
            "passed": False,
            "reason": f"APY 过低: {apy:.1%} < {MIN_APY:.0%}",
            "suggestion": f"需要至少 {MIN_APY * opportunity.days_to_resolution / 365:.1%} 的绝对利润"
        }
    
    return {
        "passed": True,
        "apy": apy,
        "rating": "优秀" if apy > 0.5 else "良好" if apy > 0.25 else "可接受"
    }
```

## 6.6 Layer 5: 人工复核清单

```markdown
## 套利机会复核清单

### 基本信息
- 机会ID: _______________
- 套利类型: _______________
- 发现时间: _______________
- 预计结算时间: _______________
- 锁仓天数: _______________

### 1. 逻辑验证 ✓/✗
- [ ] LLM 判断的逻辑关系我理解并认同
- [ ] 我能用自己的话解释为什么这个关系成立
- [ ] 我考虑过所有边界情况

### 2. 预言机验证 ✓/✗
- [ ] 两市场结算来源**完全相同**
- [ ] 或者结算来源有明确的权威性顺序
- [ ] 我检查了历史上是否有分歧案例

### 3. 时间验证 ✓/✗
- [ ] 两市场结算时间差 ≤ 24 小时
- [ ] 时区已确认并转换为 UTC
- [ ] 对于 A→B：B 的结算时间不早于 A

### 4. 结算规则验证 ✓/✗
- [ ] 我已**打开浏览器**阅读所有相关市场的结算规则
- [ ] 结算数据来源一致
- [ ] 不存在可能导致两边都输的情况
- [ ] 边界值处理方式已确认

### 5. 流动性验证 ✓/✗
- [ ] 我检查了订单簿深度
- [ ] 我的仓位 ≤ 市场流动性的 10%
- [ ] 滑点成本在可接受范围内

### 6. APY 验证 ✓/✗
- [ ] APY ≥ 15%
- [ ] 锁仓时间 ≤ 180 天
- [ ] 我能承受最坏情况的亏损

### 签字
- 复核人: _______________
- 复核时间: _______________
- 决定: [ ] 执行 [ ] 放弃 [ ] 需更多信息
```

---

# 7. 技术架构

## 7.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   CLI       │  │   Web UI    │  │  通知服务   │              │
│  │  (Phase 1)  │  │  (Phase 4)  │  │  (Phase 3)  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        应用服务层                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  ArbitrageScanner                        │    │
│  │            （套利扫描器 - 主编排服务）                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │              │              │              │          │
│         ▼              ▼              ▼              ▼          │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │  Data     │  │ Similarity│  │   LLM     │  │ Validation│    │
│  │  Fetcher  │  │  Filter   │  │  Analyzer │  │  Engine   │    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
│         │              │              │              │          │
│         ▼              ▼              ▼              ▼          │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │   CLOB    │  │ Semantic  │  │ Arbitrage │  │    APY    │    │
│  │  Client   │  │ Clusterer │  │  Detector │  │ Calculator│    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        基础设施层                                │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │ Polymarket│  │   CLOB    │  │  多LLM    │  │  Cache    │    │
│  │  Gamma API│  │    API    │  │  提供商   │  │  System   │    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## 7.2 核心组件

| 组件 | 职责 | 关键方法 |
|------|------|----------|
| **DataFetcher** | 异步获取市场及订单簿 | `enrich_market_with_orderbook()` |
| **SemanticClusterer** | 向量化聚类 (BGE-M3) | `cluster_markets()` |
| **LLMAnalyzer** | 批量逻辑分析 | `analyze_cluster()` |
| **ValidationEngine** | 五层级风控核验 | `validate_all_layers()` |
| **ExecutionEngine** | Layer 6 终极验证与执行 | `pre_flight_check()`, `execute_mock()` |
| **ArbitrageNotifier** | 实时多端通知 | `send_notification()` |
| **DepthCalculator** | 精确 VWAP 与滑点预估 | `calculate_vwap()` |

## 7.3 数据流 (六层验证闭环)

1. **Layer 1 (Discovery)**: LLM 通过语义聚类发现逻辑违背。
2. **Layer 2 (Rules)**: 规则引擎检查 Oracle 来源和时间戳对齐。
3. **Layer 3 (Math)**: `DepthCalculator` 根据目标规模计算真实 VWAP。
4. **Layer 4 (Return)**: `APYCalculator` 评估年化收益是否满足门槛。
5. **Layer 5 (Human)**: 生成 Markdown 复核清单供手动核验。
6. **Layer 6 (Pre-flight)**: 下单瞬间重新抓取价格，确认套利空间存在。

## 7.4 配置管理

```python
@dataclass
class ScanSettings:
    """扫描配置 (v3.6 生产级)"""
    market_limit: int = 1000

    # 🆕 利润与风控门槛
    min_profit_pct: float = 2.0        # 最小利润率 (%)
    min_apy: float = 15.0              # 最小年化收益率 (%)
    target_size_usd: float = 500.0     # 模拟交易规模 (用于精算)
    max_days_to_resolution: int = 180  # 最大锁仓时间

    # 🆕 策略增强配置
    use_semantic_clustering: bool = True
    enable_orderbook: bool = True
    exclude_resolved: bool = True

    # 🆕 运行模式
    loop_mode: bool = False            # 是否开启高频轮询
    interval_seconds: int = 300        # 扫描间隔

@dataclass
class RiskSettings:
    """风控配置"""
    max_single_position: float = 0.10  # 单笔最大仓位（占总资金）
    max_daily_exposure: float = 0.30   # 日最大敞口
    max_event_exposure: float = 0.20   # 单事件最大敞口
    
    # Gas 和滑点预估
    estimated_gas_cost_usd: float = 2.0
    max_slippage_pct: float = 3.0
```

## 7.5 CLI 交互式架构 (v3.1 新增)

> 本系统的交互式用户界面设计遵循"交互优先、渐进披露、即时反馈"三大原则。

### 7.5.1 交互式菜单系统

**入口**: `cli/menu.py:InteractiveMenu`

```
主菜单
├── 开始扫描 → 领域选择 → 策略多选 → 子类别 → 运行模式 → 确认
├── 配置设置
├── 查看历史
├── 帮助文档
└── 退出
```

**特性**:
- 使用 `questionary` 提供交互式提示
- 支持策略多选（checkbox）
- 自动显示策略元数据（风险等级、描述）
- 配置确认表格展示

### 7.5.2 规范化输出系统

**入口**: `cli/output.py:ScannerOutput`

**输出格式示例**:
```
[1/4] 获取市场数据...
  OK 获取到 156 个 crypto (ETH, SOL) 市场

[2/4] 执行单调性违背套利...
  ✓ 发现 2 个机会

┌──────────────── #1 套利机会 ────────────────┐
│ MONOTONICITY_VIOLATION                      │
│ 利润: 3.45%  成本: $0.9655  回报: $1.0000   │
└─────────────────────────────────────────────┘
```

**特性**:
- 使用 `rich` 库进行终端格式化
- 进度条显示耗时操作
- 机会发现时立即高亮显示
- 支持 fallback 到简单输出模式（非TTY环境）

### 7.5.3 策略注册表

**入口**: `strategies/registry.py:StrategyRegistry`

**已注册策略**:

| ID | 名称 | 优先级 | 需LLM | 风险等级 |
|----|------|--------|-------|----------|
| `monotonicity` | 单调性违背套利 | 1 | 否 | LOW |
| `interval` | 区间套利 | 2 | 否 | LOW |
| `exhaustive` | 完备集套利 | 3 | 否 | MEDIUM |
| `implication` | 蕴含关系套利 | 4 | 是 | MEDIUM |
| `equivalent` | 等价市场套利 | 5 | 是 | MEDIUM |

**策略元数据结构**:
```python
@dataclass
class StrategyMetadata:
    id: str                      # 唯一标识
    name: str                    # 中文名称
    name_en: str                 # 英文名称
    description: str             # 简述
    priority: int                # 优先级（越小越高）
    requires_llm: bool           # 是否需要LLM
    domains: List[str]           # 适用领域
    risk_level: RiskLevel        # 风险等级
    min_profit_threshold: float  # 最低利润阈值
```

**新增策略示例**:
```python
from strategies import BaseArbitrageStrategy, StrategyMetadata, StrategyRegistry

@StrategyRegistry.register
class MyNewStrategy(BaseArbitrageStrategy):
    @property
    def metadata(self) -> StrategyMetadata:
        return StrategyMetadata(
            id="my_strategy",
            name="我的新策略",
            name_en="My New Strategy",
            description="策略描述",
            priority=6,
            requires_llm=False,
            domains=["crypto"],
            risk_level=RiskLevel.LOW,
            min_profit_threshold=2.0
        )

    def scan(self, markets, config, progress_callback=None):
        # 实现扫描逻辑
        pass
```

### 7.5.4 命令行模式

系统支持命令行参数模式，适用于自动化脚本：

```bash
# 非交互模式运行
python local_scanner_v2.py --no-interactive --domain crypto --monotonicity-check

# 所有现有参数保持兼容
python local_scanner_v2.py --domain crypto --subcat btc,eth --threshold 0.80
```

---

## 7.6 语义路由器架构（Semantic Router Architecture）

> **v3.0 新增** - 基于《语义Alpha》深度研究报告的技术架构

系统采用"语义路由器"架构，分为四个核心模块：

### 模块一：全景数据摄取 (The Watchtower)

**职责**：实时维护包含所有活跃市场的"全域状态库"

**实现**：
- 每隔 N 秒调用 Gamma API 获取新市场
- 按 volume 和 liquidity 过滤低流动性市场（<$1000）
- 将市场描述文本存入暂存区供后续分析

### 模块二：语义路由器与聚类 (The Linguist)

**职责**：核心智能层，进行向量化聚类和语义分类

**实现**：
1. **向量化**：使用 Embedding 模型将市场文本转化为高维向量
2. **聚类**：利用向量数据库进行相似度搜索，找出"语义邻居"
3. **语义路由**：识别市场结构类型
   - Threshold：阈值型（BTC > 100k）
   - Interval：区间型（BTC 90k-100k）
   - Discrete：离散型（谁会赢）

### 模块三：逻辑验证与套利识别 (The Actuary)

**职责**：接收结构化数据，执行确定性的数学检查

**核心检查器**：
1. **单调性检查器 (Monotonicity Checker)**：检测阈值市场的价格倒挂
2. **区间求和检查器 (Partition Checker)**：检测互补区间价格总和 < 1
3. **蕴含关系检查器 (Implication Checker)**：检测 P(B) < P(A) 的违背（当 A→B）

### 模块四：风险门控与执行 (The Guardian & Executor)

**职责**：下单前进行最后的语义风险评估

**风险检测重点**：
1. 数据源一致性（Binance vs Coinbase）
2. 时间定义一致性（"By" vs "Before"）
3. 取整规则差异（"3.0%" vs "3%"）

**风险检测Prompt**：
```
对比市场A和市场B的决议规则。注意以下陷阱：
1. 数据源是否完全一致？
2. 时间定义是否一致？
3. 是否存在取整规则差异？
如果存在任何可能导致决议结果不一致的差异，输出RISK_HIGH，否则输出RISK_LOW。
```

---

# 8. 数据模型

## 8.1 核心实体

### Market（市场）

```python
@dataclass
class Market:
    id: str
    question: str
    description: Optional[str]
    
    # 价格数据
    yes_price: float        # Mid/Last price（仅参考）
    no_price: float
    
    # 订单簿数据（v2.0 新增）
    best_bid: Optional[float]
    best_ask: Optional[float]
    spread: Optional[float]
    
    # 元数据
    volume: float
    liquidity: float
    event_id: Optional[str]
    end_date: Optional[str]
    resolution_source: Optional[str]  # 结算来源
    
    # 区间/阈值信息
    group_item_title: Optional[str]
    interval_data: Optional[IntervalData]
```

### RelationType（关系类型）

```python
class RelationType(Enum):
    IMPLIES_AB = "implies_ab"       # A → B
    IMPLIES_BA = "implies_ba"       # B → A
    EQUIVALENT = "equivalent"       # A ≡ B
    MUTUAL_EXCLUSIVE = "mutual_exclusive"  # A ⊕ B
    EXHAUSTIVE = "exhaustive"       # 完备集的一部分
    TEMPORAL_SEQUENCE = "temporal_sequence"  # 时序相关（v2.0 新增）
    UNRELATED = "unrelated"
```

### ArbitrageOpportunity（套利机会 - v3.6 补完版）

```python
@dataclass
class ArbitrageOpportunity:
    id: str
    type: str                # MONOTONICITY | IMPLICATION | ...
    markets: List[dict]      # 包含 ID, Question, Price, TokenID
    relationship: str

    # 收益与风控度量 (Phase 2.5/4.1 核心字段)
    total_cost: float        # 组合成本
    profit_pct: float        # 净利润率
    apy: float               # 年化收益率
    apy_rating: str          # EXCELLENT | GOOD | LOW

    mid_price_profit: float  # 理论中间价利润
    effective_profit: float  # VWAP 实际成交利润
    slippage_cost: float     # 预估滑点损耗 (USD)

    days_to_resolution: int  # 预估锁仓天数
    oracle_alignment: str    # ALIGNED | MISALIGNED

    # 执行与验证
    validation_results: dict # 各层级详细评分
    checklist_path: str      # 本地复核清单路径
    gas_estimate: float      # Polygon 执行成本
    max_position_usd: float  # 建议最大仓位 (Liquidity * 10%)
```

## 8.2 持久化设计

### JSON 文件结构

```
output/
├── scans/
│   └── scan_20260107_103045.json    # 单次扫描结果
├── opportunities/
│   └── opp_impl_20260107_1.json     # 单个套利机会详情
├── verified/
│   └── verified_20260107_1.json     # 人工验证通过的机会
├── executed/
│   └── exec_20260107_1.json         # 已执行的交易
└── cache/
    ├── relationship_cache.json      # LLM 分析缓存
    ├── order_book_cache.json        # 订单簿缓存
    └── market_cache.json            # 市场数据缓存
```

---

# 9. 核心算法

## 9.1 相似度计算

### Phase 1: Jaccard + BM25 混合

```python
def calculate_similarity(market_a: Market, market_b: Market) -> float:
    """
    综合相似度计算
    
    改进: 使用 BM25 替代纯 Jaccard，对关键实体词加权
    """
    # BM25 相似度（对关键词加权）
    bm25_sim = bm25_similarity(market_a.question, market_b.question)
    
    # 同事件加权
    if market_a.event_id and market_a.event_id == market_b.event_id:
        bm25_sim += 0.4
    
    # 同结算日加权
    if market_a.end_date and market_a.end_date == market_b.end_date:
        bm25_sim += 0.1
    
    return min(bm25_sim, 1.0)
```

### Phase 2: 向量语义相似度

```python
class SemanticClusterer:
    def __init__(self, model_name="BAAI/bge-large-zh-v1.5"):
        self.model = SentenceTransformer(model_name)
    
    def find_similar_markets(self, query: str, markets: List[Market],
                            threshold: float = 0.85) -> List[Tuple[Market, float]]:
        """基于余弦相似度查找相似市场"""
        query_emb = self.model.encode([query], normalize_embeddings=True)[0]
        market_texts = [f"{m.question} {m.description or ''}" for m in markets]
        market_embs = self.model.encode(market_texts, normalize_embeddings=True)
        
        similarities = np.dot(market_embs, query_emb)
        results = [(markets[i], similarities[i]) for i in range(len(markets))
                  if similarities[i] >= threshold]
        return sorted(results, key=lambda x: x[1], reverse=True)
```

## 9.2 套利检测算法

### 完备集套利检测（增强版）

```python
def detect_exhaustive_arbitrage(
    markets: List[Market],
    target_size_usd: float = 500,
    min_apy: float = 0.15
) -> Optional[ArbitrageOpportunity]:
    """
    检测完备集套利（v2.0 增强版）
    
    增强点:
    1. 使用 VWAP 而非 Mid Price
    2. 计算 APY
    3. 验证 Oracle 对齐
    """
    if len(markets) < 2:
        return None
    
    # 验证 Oracle 对齐
    sources = [m.resolution_source for m in markets]
    if len(set(sources)) > 1:
        logger.warning(f"Oracle 不一致: {sources}")
        return None  # 或降级处理
    
    # 获取 VWAP
    effective_prices = []
    for m in markets:
        vwap = calculate_vwap(get_order_book(m.id), target_size_usd / len(markets))
        if vwap["insufficient_liquidity"]:
            return None
        effective_prices.append(vwap["ask_vwap"])
    
    # 计算成本和利润
    total_cost = sum(effective_prices)
    
    if total_cost >= 0.98:  # 预留 2% 给 Gas
        return None
    
    profit = 1.0 - total_cost
    profit_pct = (profit / total_cost) * 100
    
    # 计算 APY
    days = calculate_days_to_resolution(markets[0])
    apy = profit_pct * (365 / days) / 100
    
    if apy < min_apy:
        return None
    
    # 同时计算中间价利润（对比）
    mid_price_profit = 1.0 - sum(m.yes_price for m in markets)
    
    return ArbitrageOpportunity(
        type="EXHAUSTIVE_SET_UNDERPRICED",
        markets=[market_to_dict(m) for m in markets],
        total_cost=total_cost,
        mid_price_profit=mid_price_profit,
        effective_profit=profit,
        profit_pct=profit_pct,
        days_to_resolution=days,
        apy=apy,
        apy_rating=get_apy_rating(apy),
        oracle_alignment="ALIGNED",
        # ...
    )
```

### 包含关系套利检测（增强版）

```python
def detect_implication_arbitrage(
    market_a: Market,
    market_b: Market,
    analysis: RelationshipAnalysis,
    target_size_usd: float = 500,
    min_apy: float = 0.15
) -> Optional[ArbitrageOpportunity]:
    """
    检测包含关系套利（v2.0 增强版）
    
    增强点:
    1. 阈值方向验证
    2. Oracle 对齐检查
    3. 时间一致性检查
    4. APY 计算
    """
    # Layer 2 验证: 阈值方向
    if not validate_threshold_direction(market_a, market_b, analysis.relationship):
        logger.warning("阈值方向验证失败")
        return None
    
    # Layer 2 验证: Oracle 对齐
    oracle_status = check_oracle_alignment(market_a, market_b)
    if oracle_status == "MISALIGNED":
        logger.warning("Oracle 不一致")
        return None
    
    # Layer 2 验证: 时间一致性
    if not check_temporal_consistency(market_a, market_b, analysis.relationship):
        logger.warning("时间一致性验证失败")
        return None
    
    # 确定蕴含方向
    if analysis.relationship == RelationType.IMPLIES_AB:
        implying = market_a
        implied = market_b
    else:
        implying = market_b
        implied = market_a
    
    # 获取真实订单簿价格
    implied_vwap = calculate_vwap(get_order_book(implied.id), target_size_usd / 2)
    implying_ob = get_order_book(implying.id)
    implying_no_vwap = calculate_vwap_no(implying_ob, target_size_usd / 2)
    
    if implied_vwap["insufficient_liquidity"] or implying_no_vwap["insufficient_liquidity"]:
        return None
    
    # 检查是否违反约束
    if implied_vwap["ask_vwap"] >= implying.yes_price - 0.01:
        return None  # 定价正确，无套利
    
    # 计算套利
    cost = implied_vwap["ask_vwap"] + implying_no_vwap["ask_vwap"]
    profit = 1.0 - cost
    profit_pct = (profit / cost) * 100 if cost > 0 else 0
    
    # 计算 APY
    days = max(
        calculate_days_to_resolution(implied),
        calculate_days_to_resolution(implying)
    )
    apy = profit_pct * (365 / days) / 100
    
    if apy < min_apy:
        return None
    
    # 同时计算中间价利润
    mid_price_cost = implied.yes_price + implying.no_price
    mid_price_profit = 1.0 - mid_price_cost
    
    return ArbitrageOpportunity(
        type="IMPLICATION_VIOLATION",
        markets=[market_to_dict(implied), market_to_dict(implying)],
        relationship=analysis.relationship.value,
        total_cost=cost,
        mid_price_profit=mid_price_profit,
        effective_profit=profit,
        profit_pct=profit_pct,
        days_to_resolution=days,
        apy=apy,
        apy_rating=get_apy_rating(apy),
        oracle_alignment=oracle_status,
        # ...
    )
```

## 9.3 利润计算公式汇总

| 套利类型 | 成本公式 | 回报公式 | APY 公式 |
|----------|----------|----------|----------|
| 完备集 | Σ(VWAP_YES_i) | 1.00 | (1-成本)/成本 × 365/天数 |
| 包含关系 A→B | VWAP_YES_B + VWAP_NO_A | 1.00 | (1-成本)/成本 × 365/天数 |
| 等价市场 | VWAP_YES_cheap + VWAP_NO_expensive | 1.00 | (1-成本)/成本 × 365/天数 |
| 区间互补 | Σ(VWAP_YES_intervals) | 1.00 | (1-成本)/成本 × 365/天数 |

---

# 10. 开发路线图

## 10.1 Phase 1: MVP 验证 ✅

**目标**：验证核心策略可行性
**状态**：已完成

### 交付物
- [x] `polymarket_arb_mvp.py` - MVP 完整脚本
- [x] `local_scanner_v2.py` - 支持多 LLM 的扫描器
- [x] `llm_providers.py` - LLM 提供商抽象层
- [x] 多 LLM 提供商支持

## 10.2 Phase 2: 真实数据验证 ✅

**目标**：在真实市场数据上验证
**状态**：大部分完成

### 任务清单
- [x] 实现 Polymarket API 客户端
- [x] 向量化相似度筛选
- [x] 区间套利检测
- [x] Tag 分类系统
- [ ] **发现并验证 3 个真实套利机会**

## 10.2.5 Sprint 0: 单调性违背套利专项 🆕

> **优先级**：P0（最高）
> **领域聚焦**：加密货币

**目标**：实现加密货币领域的单调性违背套利检测
**状态**：✅ 已完成 (100%)

### 任务清单

| 任务ID | 任务名称 | 描述 | 状态 |
|--------|----------|------|------|
| T0.1 | MonotonicityChecker | 实现单调性违背检测算法 | ✅ 已完成 |
| T0.2 | ThresholdMarketIdentifier | 自动识别阈值型市场（above/below） | ✅ 已完成 |
| T0.3 | CryptoFocusedScanner | 专注加密货币领域的扫描命令 | ✅ 已完成 |
| T0.4 | LadderMarketGrouper | 阶梯行权价市场分组器 | ✅ 已完成 |
| T0.5 | 真实案例验证 | 在Polymarket找到至少1个单调性违背案例 | ✅ 已完成 |

### 验收标准

- [x] 能够自动识别加密货币阈值市场 ← 支持14种加密资产
- [x] 能够检测价格倒挂（单调性违背） ← check_monotonicity() 已实现
- [x] 输出包含套利计算和APY ← calculate_arbitrage() 已实现
- [x] 至少发现1个真实案例 ← CASE-001: SOL $110 vs $120 单调性违背

## 10.3 Phase 2.5: 精度与风控 🆕

> **v2.0 新增** - 风控前置

**目标**：实现完整的风控和验证体系
**时间**：2 周
**状态**：进行中

### 任务清单

| 任务 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| T2.5.1 | 实现 `APYCalculator` - 过滤低年化收益机会 | P0 | 待开始 |
| T2.5.2 | 实现 `OracleComparator` - 提取并比对结算来源 | P0 | 待开始 |
| T2.5.3 | 实现 `DepthCalculator` - 订单簿 VWAP 计算 | P0 | 待开始 |
| T2.5.4 | 实现 `ValidationEngine` - 五层验证框架 | P0 | 待开始 |
| T2.5.5 | 阈值方向验证器增强 | P1 | 待开始 |
| T2.5.6 | 时间一致性验证器 | P1 | 待开始 |
| T2.5.7 | 人工复核清单生成器 | P1 | 待开始 |
| T2.5.8 | 输出格式增强（显示 APY、滑点对比） | P1 | 待开始 |

### 验收标准
- APY 计算器准确率 100%
- Oracle 对齐检查覆盖所有机会
- 验证框架能够过滤 50%+ 的低质量机会

## 10.4 Phase 3: 策略扩展

**目标**：扩展套利策略覆盖面
**时间**：3-4 周
**状态**：计划中

### 任务清单

| 任务 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| T3.1 | 增强区间套利检测 - 跨 Event 区间关系 | P0 | 部分完成 |
| T3.2 | 时序套利检测 | P1 | 待开始 |
| T3.3 | WebSocket 实时监控 | P2 | 待开始 |
| T3.4 | 通知功能（Telegram/微信） | P2 | 待开始 |
| T3.5 | 历史回测系统 | P1 | 待开始 |
| T3.6 | ~~跨平台套利（Myriad）~~ | **降级** | 暂缓 |

> ⚠️ **T3.6 降级说明**：跨链套利成本过高（见第 4 章风险分析），暂缓实现，专注 Polymarket 内部套利。

## 10.5 Phase 4: 半自动执行

**目标**：实现安全的半自动执行流程
**时间**：4 周
**状态**：计划中

### 任务清单
- [ ] T4.1 设计执行引擎
- [ ] T4.2 实现 Polymarket 交易接口
- [ ] T4.3 实现钱包管理
- [ ] T4.4 实现风控模块
- [ ] T4.5 实现半自动执行（需人工确认）
- [ ] T4.6 交易记录和追踪
- [ ] T4.7 盈亏统计

## 10.6 里程碑

```
2024/12/29 ─── M1: MVP 完成 ✅
     │
2026/01/07 ─── M2: 真实数据验证大部分完成 ✅
     │         v2.1.4 交互式子类别选择
     │
     ├─ Phase 2.5 开始 (风控前置)
     │
2026/01/21 ─── M2.5: 风控体系完成
     │         - APY 计算器
     │         - Oracle 对齐检查
     │         - 订单簿深度分析
     │         - 五层验证框架
     │
     ├─ 待完成: 发现并验证 3 个真实套利案例
     │
2026/02/?? ─── M3: 策略扩展完成
     │
2026/03/?? ─── M4: 半自动执行完成
```

---

# 11. 运维与监控

## 11.1 部署方式

| 阶段 | 方式 | 说明 |
|------|------|------|
| Phase 1-3 | 本地运行 | 手动或 crontab 定时扫描 |
| Phase 4+ | 服务器部署 | 持续监控模式 |

## 11.2 监控指标

| 指标 | 目标 | 告警阈值 |
|------|------|----------|
| 每日扫描次数 | ≥4 | <2 |
| 机会发现数/周 | ≥3 | <1 |
| 验证通过率 | ≥50% | <30% |
| APY ≥15% 占比 | ≥50% | <30% |
| API 调用成功率 | ≥99% | <95% |

## 11.3 日志规范

```python
# 日志级别使用规范
DEBUG: 详细的调试信息，包括 API 响应、中间计算结果
INFO:  正常操作记录，如扫描开始/结束、发现机会
WARN:  需要注意的情况，如验证失败、流动性不足
ERROR: 错误情况，如 API 失败、解析异常
```

---

# 12. 扩展计划

## 12.1 新套利类型

| 类型 | 说明 | 状态 |
|------|------|------|
| **时序套利** | 累积概率关系 | 🆕 计划中 |
| 合成套利 | 区间/阈值市场组合等价于单一市场 | 🔄 开发中 |
| 时间套利 | 同一事件不同时间点市场价差 | ⏳ 待规划 |

## 12.2 平台扩展（审慎评估）

| 平台 | 说明 | 建议 |
|------|------|------|
| **Polymarket 内部** | 同链、同合约、原子化 | ✅ **核心聚焦** |
| Myriad (BNB Chain) | 去中心化，用户群体分割 | 🟡 长期评估 |
| Drift BET (Solana) | 去中心化，低费用 | 🟡 长期评估 |
| 跨链套利 | 成本过高 | ❌ 暂不考虑 |

---

# 13. 真实案例复盘

> 🆕 **v3.0 新增**：通过真实案例学习套利策略的应用

## 13.1 [NEW] 2026 生产级实战案例
1. **[CASE-001: BTC 价格阶梯单调性违背](./cases/CASE-001_BTC_Monotonicity.md)** (APY: 184.3%)
2. **[CASE-002: ETH 价格阶梯单调性违背](./cases/CASE-002_ETH_Monotonicity.md)** (高流动性 Alpha)
3. **[CASE-003: 风险拦截案例（时间戳冲突）](./cases/CASE-003_Risk_Interception.md)** (风控引擎实证)

## 13.2 案例1：乌克兰矿产协议争议（2025.3）

### 背景
市场问题："乌克兰是否会在 4 月前同意特朗普的矿产协议？"

### 事件经过
1. **特朗普声称**：即将签署协议
2. **泽连斯基发表**：模糊讲话，未明确表态
3. **实际情况**：没有任何官方条约签署

### 市场反应与博弈

```
Polymarket 官方（Discord）：
└─ 倾向判定为 NO（"Too Early"）
└─ YES 价格暴跌

UMA 预言机投票：
└─ 持 25% 投票权的巨鲸支持 YES
└─ 理由：政治声明已构成"实质性同意"
```

### 套利机会

**时机**：当 Polymarket 官方说 NO，但 UMA 大户倾向 YES 时

**操作**：YES 被错杀至 $0.10 甚至更低时买入

**潜在收益**：如果 UMA 最终裁定 YES，收益 10x

### 核心教训

1. **监控 UMA Discord `#voting-discussion` 频道**
2. 社区讨论往往能提前 24-48 小时预示投票结果
3. 官方判断 ≠ 最终结算结果
4. 理解治理机制是语义套利的核心

---

## 13.2 案例2：LK-99 室温超导（2023-2024）

### 背景
市场问题："室温超导是否成真？"

韩国团队发布论文声称发现室温超导材料 LK-99。

### 市场疯狂

```
炒作期：
└─ YES 价格冲高至 60%+
└─ 媒体大肆报道"物理学革命"
└─ 散户 FOMO 买入
```

### 专家洞察

物理学博士或材料学专家在阅读论文后迅速发现：
- 数据中存在明显错误
- 抗磁性（diamagnetism）被误判为超导性
- 样品制备过程不可重复

### 套利操作

```
大众行为：媒体炒作 → 疯狂买入 YES
专家行为：论文分析 → 自信买入 NO

买入 NO @ $0.40（甚至更低）
胜率评估：接近 99%
```

### 结果
随着全球多个实验室复现失败，YES 价格归零，NO 持有者大赚。

### 核心教训

1. **领域专业知识是长尾市场的核心 Alpha**
2. 机器人缺乏解读科学论文的能力
3. 在你的专业领域，你就是"庄家"
4. 避开首页热门，深入 Science/Business/Pop Culture 板块

---

## 13.3 案例3：TikTok 禁令风波

### 背景
市场问题："TikTok 是否会被禁？"

### 规则模糊性分析

```
争议焦点：什么算"Banned"？

可能的定义：
1. 总统签署法案 → 法律层面禁令
2. App Store 下架 → 用户无法下载
3. 服务器关闭 → 完全无法使用

实际情况：
└─ 法律通过了
└─ 法院暂缓执行
└─ App 依然可以下载
```

### LLM 辅助分析

使用 LLM 分析法条与市场规则的匹配度：

```
Prompt:
"以下是 TikTok 禁令市场的 Resolution Rules：
[规则文本]

以下是当前法律状态：
[新闻摘要]

请分析：根据规则，当前状态应该判定为 YES 还是 NO？
列出可能的争议点。"
```

### 套利机会

**时机**：市场恐慌时（如"法案通过"新闻发布后）

**分析**：法院暂缓执行意味着 App 仍可用，可能判定为 NO

**操作**：以低价买入 NO（如果规则定义是"App Store 下架"）

### 核心教训

1. **规则文本分析是语义套利的核心技能**
2. 必须逐字阅读 Resolution Rules
3. LLM 可以辅助分析边界情况
4. 市场恐慌往往创造最佳买点

---

# 14. 创意池

## 14.1 待评估的创意

| ID | 创意描述 | 来源 | 状态 | 备注 |
|----|----------|------|------|------|
| I001 | 多 LLM 交叉验证 | 初始想法 | 待评估 | 提高准确率 |
| I002 | 历史套利模式库 | 初始想法 | 待评估 | 减少 LLM 调用 |
| I003 | 事件关联图谱 | 初始想法 | 待评估 | 可视化分析 |
| I004 | 自动化人工复核表单 | v2.0 | 待评估 | 提高复核效率 |
| I005 | 机会推送到 Notion/飞书 | v2.0 | 待评估 | 便于追踪 |

## 14.2 已采纳的创意

| ID | 创意描述 | 采纳日期 | 纳入阶段 |
|----|----------|----------|----------|
| I-APY | 年化收益率计算 | 2026-01-07 | Phase 2.5 |
| I-Oracle | 预言机对齐检查 | 2026-01-07 | Phase 2.5 |
| I-Depth | 订单簿深度分析 | 2026-01-07 | Phase 2.5 |

## 14.3 已否决的创意

| ID | 创意描述 | 否决原因 | 否决日期 |
|----|----------|----------|----------|
| I-XChain | 跨链套利 | 成本过高，见风险分析 | 2026-01-07 |

---

# 15. 附录

## 15.1 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 套利 | Arbitrage | 利用价格差异获取无风险利润 |
| 完备集 | Exhaustive Set | 覆盖所有可能结果的互斥选项集合 |
| 包含关系 | Implication | A 发生必然导致 B 发生的逻辑关系 |
| 预言机 | Oracle | 向区块链提供链外数据的机制 |
| 流动性 | Liquidity | 市场中可交易的资金量 |
| 滑点 | Slippage | 预期价格与实际成交价的差异 |
| APY | Annual Percentage Yield | 年化收益率 |
| VWAP | Volume Weighted Average Price | 成交量加权平均价 |
| CLOB | Central Limit Order Book | 中央限价订单簿 |
| CTF | Conditional Token Framework | Gnosis 条件代币框架 |

## 15.2 散户行动清单 🆕

> 在这个市场里，不做"赌徒"，做"信息猎人"。

### 工具武装清单

- [ ] **区块浏览器账户**
  - Etherscan：监控以太坊上的 UMA 代币动向
  - Polygonscan：监控 Polymarket 合约交互

- [ ] **社区潜伏**
  - UMA Protocol Discord：关注 `#voting-discussion` 频道
  - Polymarket Discord：关注官方公告和社区讨论

- [ ] **LLM 工具配置**
  - 规则模糊度分析 Prompt
  - 新闻情绪分析 Prompt
  - 相关性挖掘 Prompt

- [ ] **可选：跨平台准备**
  - 如有美国身份：Kalshi 账户注册
  - 替代方案：研究同链跨平台机会

### 领域选择指南

根据你的专业背景选择狩猎场：

| 你的背景 | 适合的市场类型 | 信息优势来源 |
|----------|----------------|--------------|
| 医生/生物学家 | FDA 药物批准 | 临床数据解读、审批流程 |
| 程序员/AI从业者 | AI 模型发布时间 | 技术社区、GitHub动态 |
| 物理学家/材料学家 | 科学突破市场 | 论文解读、实验复现 |
| 航天爱好者 | SpaceX/航天任务 | 硬核论坛、基地监控 |
| 二次元/娱乐圈 | 动漫销量、电影票房 | 粉丝社区、预售数据 |
| 法律从业者 | 法院判决、法案通过 | 法律程序、判例分析 |
| 金融从业者 | 央行决策、经济指标 | 政策解读、数据分析 |

### 执行纪律

1. **永远使用限价单（Limit Order）**
   - 市价单会被狙击，滑点惨重
   - 挂单在你愿意成交的价格

2. **计算 YES + NO 成本**
   - 任何套利前先算真实成本
   - 使用 VWAP 而非显示价格

3. **学会手动 Merge 离场**
   - 不要等最终宣判
   - 锁定利润，避免 UMA 判错的黑天鹅

4. **控制仓位**
   - 单笔不超过总资金 10%
   - 单事件不超过总资金 20%

## 15.3 铸币与销毁操作指南 🆕

> Polymarket 基于 Gnosis CTF（Conditional Token Framework），理解底层机制可以锁定利润。

### Split（拆分）操作

将 USDC 拆分为 YES + NO 代币对。

```
操作：1 USDC → 1 YES + 1 NO

用途：
1. 构建双向头寸做市
2. 在高波动市场赚取点差
3. 无风险持有"完整套"等待时机

入口位置：
- 新版 UI：市场页面右上角菜单 → "Split Shares"
- 或 Portfolio 页面的持仓详情
- 高级用户：直接与 Gnosis CTF Exchange 合约交互
```

### Merge（合并）操作

将 YES + NO 代币对合并回 USDC。

```
操作：1 YES + 1 NO → 1 USDC

用途：
1. 锁定套利利润，立即落袋为安
2. 不等最终宣判，避免 UMA 判错风险
3. 释放资金用于其他机会

操作步骤：
1. 确保钱包里有等量的 YES 和 NO
2. 点击 "Merge Shares"
3. 确认交易
4. 代币销毁，USDC 入账
```

### 套利场景示例

**场景：发现 3% 套利机会但想立即落袋**

```
Step 1: 发现套利
- Market A: YES = $0.45
- Market B: NO  = $0.52
- 总成本：$0.97

Step 2: 执行买入
- 买入 A-YES @ $0.45
- 买入 B-YES @ $0.52（即 A-NO）

Step 3: 立即 Merge
- 合并 A-YES + A-NO → 1 USDC
- 净利润：$0.03 (3.1%)

无需等待结算，风险归零！
```

### 注意事项

- Gas 费用：Merge 操作比普通 ERC20 转账贵 3-5 倍
- 小额套利（<$200）需特别注意 Gas 占比
- 计算真实利润时需扣除 Gas 成本

## 15.4 常用命令

```bash
# 基本运行
python local_scanner_v2.py

# 按领域扫描
python local_scanner_v2.py --semantic --domain crypto

# 交互式子类别选择
python local_scanner_v2.py

# 强制刷新数据
python local_scanner_v2.py --refresh

# 使用缓存数据
python local_scanner_v2.py --use-cache
```

## 15.5 配置文件示例

```json
{
  "llm": {
    "provider": "deepseek",
    "model": "deepseek-chat",
    "max_tokens": 2000,
    "temperature": 0.7
  },
  "scan": {
    "market_limit": 200,
    "min_profit_pct": 2.0,
    "min_apy": 0.15,
    "max_days_to_resolution": 180,
    "min_liquidity": 10000,
    "min_confidence": 0.8,
    "require_oracle_alignment": true
  },
  "risk": {
    "max_single_position": 0.10,
    "max_daily_exposure": 0.30,
    "max_slippage_pct": 3.0,
    "estimated_gas_cost_usd": 2.0
  },
  "output": {
    "output_dir": "./output",
    "cache_dir": "./cache",
    "log_level": "INFO"
  }
}
```

## 15.6 参考资源

### 学术研究

1. IMDEA Networks Institute (2025). "Unravelling the Probabilistic Forest: Arbitrage in Prediction Markets"
   - arXiv: https://arxiv.org/abs/2508.03474
   - 关键发现：组合套利只占总利润的 0.24%，说明机器人不做这个

### 官方文档

1. Polymarket API: https://docs.polymarket.com/
2. Polymarket CLOB: https://github.com/Polymarket/py-clob-client
3. Gnosis CTF: https://docs.gnosis.io/conditionaltokens/

---

# 16. 回测与执行系统 (Phase 6)

> **v3.6 新增** - 支持历史数据回溯与真实交易签名

## 16.1 数据记录架构 (The Recorder)

为了验证策略在不同市场环境下的表现，系统引入了时间序列记录器。

### 存储设计 (SQLite)
```sql
CREATE TABLE market_snapshots (
    market_id TEXT,
    timestamp TEXT,      -- ISO8601 UTC
    yes_price REAL,
    best_bid REAL,       -- 真实买单深度
    best_ask REAL,       -- 真实卖单深度
    best_bid_no REAL,    -- NO 合约最佳买价
    best_ask_no REAL,    -- NO 合约最佳卖价
    liquidity REAL,
    PRIMARY KEY (market_id, timestamp)
);

CREATE TABLE market_metadata (
    market_id TEXT PRIMARY KEY,
    question TEXT,
    description TEXT,
    outcomes TEXT,
    event_id TEXT,
    end_date TEXT,
    group_item_title TEXT,
    first_seen TEXT
);

CREATE TABLE opportunity_history (
    opp_id TEXT PRIMARY KEY,
    type TEXT,
    first_seen TEXT,     -- 首次发现时间
    last_seen TEXT,      -- 最后有效时间
    max_profit_pct REAL, -- 存续期内最大利润
    details_json TEXT
);

CREATE TABLE execution_history (
    exec_id TEXT PRIMARY KEY,
    opp_id TEXT,
    timestamp TEXT,      -- 执行时间 (UTC)
    mode TEXT,           -- 'MOCK' (模拟) 或 'REAL' (真实)
    status TEXT,         -- 'SUCCESS', 'FAILED', 'REJECTED_L6', 'SETTLED'
    expected_profit_pct REAL,
    total_cost_usd REAL, -- 实际执行时的 VWAP 成本
    details_json TEXT,   -- 指令快照与 API 响应
    realized_pnl REAL,   -- 已实现盈亏 (USD)
    settled_at TEXT,     -- 结算时间
    FOREIGN KEY (opp_id) REFERENCES opportunity_history (opp_id)
);
```

**采集策略**:
- **高频模式**: 在 `loop` 模式下，每隔 N 秒自动快照所有活跃市场。
- **差异存储**: 仅当价格变化超过阈值（如 0.1%）时才写入新快照（待优化）。

## 16.2 回测引擎 (The Time Machine)

**核心逻辑**:
1. **时间重放**: 将 SQLite 中的快照按时间顺序重放。
2. **状态还原**: 在每个时间点，重构 `List[Market]` 对象。
3. **策略注入**: 将还原的市场数据注入 `ArbitrageScanner`，执行完全相同的策略逻辑。
4. **绩效评估**: 统计策略在历史数据上的 发现率、最大回撤、平均存续时间。

## 16.3 真实执行与签名 (The Executor)

> ⚠️ **安全警告**: 私钥仅在内存中通过环境变量加载，严禁写入磁盘。

### 签名机制 (EIP-712)
Polymarket CLOB API 要求对每个订单进行 EIP-712 签名。

**流程**:
1. **构建 Order 结构体**: 包含 Token ID, Price, Size, Side, Nonce 等。
2. **计算 Domain Separator**: 标识 Polymarket 合约域。
3. **私钥签名**: 使用 `eth_account` 对结构化数据进行签名。
4. **提交 API**: 发送包含签名的 POST 请求到 `/order` 端点。

### 安全熔断 (Kill Switch)
- **单笔限额**: 任何单笔交易不得超过 $100 (可配置)。
- **日亏损限额**: 当日累计亏损 > 5% 时自动停止。
- **干运行 (Dry Run)**: 默认开启，仅在显式确认后才发送真实签名。

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2024-12-29 | 初始版本 |
| 1.1 | 2024-12-29 | 添加多 LLM 提供商支持 |
| 1.2 | 2024-12-30 | 添加开发准则、进度追踪 |
| 1.3 | 2026-01-02 | 添加战略共识 |
| 1.4 | 2026-01-03 | 添加三大实战陷阱 |
| 2.0 | 2026-01-04 | 向量化套利发现系统 |
| 2.1.x | 2026-01-07 | 功能增强（区间套利、Tag 分类等） |
| 2.0-Bible | 2026-01-07 | 圣经重大升级：风控前置、APY 计算、五层验证框架 |
| **3.0** | **2026-01-11** | **战略升级**：基于深度研究报告的全面重构 |

---

# 核心变更摘要（v2.0 → v3.0）

## 新增章节
1. **真实案例复盘**（第 13 章）- 乌克兰矿产协议、LK-99、TikTok禁令
2. **散户行动清单**（第 15.2 节）- 工具武装、领域选择、执行纪律
3. **铸币与销毁操作指南**（第 15.3 节）- Split/Merge 操作详解

## 策略体系重构

### 新增策略类型（4个）
1. **小众/长尾市场套利（9/10分）** - 领域专家的知识变现
2. **语义套利/预言机博弈（7.5/10分）** - UMA机制深度博弈
3. **跨平台套利（8/10分）** - 保留参考+替代方案探索
4. **事件驱动交易（6.5/10分）** - 新闻发布后的价格滞后

### 明确禁区策略（2个）
1. **原子级无风险套利（0.5/10分）** - 机器人毫秒级垄断
2. **负风险自动再平衡（1/10分）** - 做市商垄断

### 优先级矩阵重排
- S级金矿：小众长尾市场 + 区间套利
- A+级：语义套利 + 包含关系
- 禁区：原子级套利 + 负风险再平衡

## LLM赋能场景细化
1. **规则模糊度检测（Rules Lawyer）** - 含Prompt模板
2. **新闻情绪与价格偏离度分析** - 工作流设计
3. **相关性挖掘（Combinatorial Analysis）** - 含示例

## 风险控制补充
1. **规则定义分歧风险** - 跨平台Resolution Rules差异
2. **UMA投票操纵风险** - 大户借贷攻击

## 核心认知升级
1. **散户优势重新定义**：不是语义理解，而是愿意等待+深度验证+领域专业知识
2. **LLM正确定位**：不是预测未来，而是分析规则和情绪
3. **执行核心**：限价单 + 手动Merge离场 + 仓位控制

---

# 核心变更摘要（v1.x → v2.0）

## 新增章节
1. **风险控制体系**（第 4 章）- 从附属章节提升为核心章节，前置于策略详解
2. **验证框架**（第 6 章）- 系统化的五层验证体系

## 重大理念升级
1. **年化思维**：任何机会必须以 APY ≥ 15% 作为最低门槛
2. **风控前置**：风险评估优先于收益计算
3. **Oracle 对齐**：结算来源一致性检查成为强制项
4. **VWAP 计算**：使用订单簿真实价格而非 Mid Price

## 策略调整
1. **跨链套利降级**：从 A- 降级为 C，暂不考虑
2. **区间套利升级**：标记为"金矿"，重点发展
3. **时序套利新增**：作为新的套利类型纳入

## 路线图调整
1. **新增 Phase 2.5**：风控与精度前置
2. **T3.6 跨平台套利暂缓**：专注 Polymarket 内部

---

**免责声明**:
本项目仅供学习研究使用。预测市场交易有风险，套利策略也存在执行风险。
请自行评估风险并承担后果。本文档不构成投资建议。

---

# 16. 回测与执行系统 (Phase 6)

> **v3.6 新增** - 支持历史数据回溯与真实交易签名

## 16.1 数据记录架构 (The Recorder)

为了验证策略在不同市场环境下的表现，系统引入了时间序列记录器。

### 存储设计 (SQLite)
```sql
CREATE TABLE market_snapshots (
    market_id TEXT,
    timestamp TEXT,      -- ISO8601 UTC
    yes_price REAL,
    best_bid REAL,       -- 真实买单深度
    best_ask REAL,       -- 真实卖单深度
    best_bid_no REAL,    -- NO 合约最佳买价
    best_ask_no REAL,    -- NO 合约最佳卖价
    liquidity REAL,
    PRIMARY KEY (market_id, timestamp)
);

CREATE TABLE market_metadata (
    market_id TEXT PRIMARY KEY,
    question TEXT,
    description TEXT,
    outcomes TEXT,
    event_id TEXT,
    end_date TEXT,
    group_item_title TEXT,
    first_seen TEXT
);

CREATE TABLE opportunity_history (
    opp_id TEXT PRIMARY KEY,
    type TEXT,
    first_seen TEXT,     -- 首次发现时间
    last_seen TEXT,      -- 最后有效时间
    max_profit_pct REAL, -- 存续期内最大利润
    details_json TEXT
);

CREATE TABLE execution_history (
    exec_id TEXT PRIMARY KEY,
    opp_id TEXT,
    timestamp TEXT,      -- 执行时间 (UTC)
    mode TEXT,           -- 'MOCK' (模拟) 或 'REAL' (真实)
    status TEXT,         -- 'SUCCESS', 'FAILED', 'REJECTED_L6', 'SETTLED'
    expected_profit_pct REAL,
    total_cost_usd REAL, -- 实际执行时的 VWAP 成本
    details_json TEXT,   -- 指令快照与 API 响应
    realized_pnl REAL,   -- 已实现盈亏 (USD)
    settled_at TEXT,     -- 结算时间
    FOREIGN KEY (opp_id) REFERENCES opportunity_history (opp_id)
);
```

**采集策略**:
- **高频模式**: 在 `loop` 模式下，每隔 N 秒自动快照所有活跃市场。
- **差异存储**: 仅当价格变化超过阈值（如 0.1%）时才写入新快照（待优化）。

## 16.2 回测引擎 (The Time Machine)

**核心逻辑**:
1. **时间重放**: 将 SQLite 中的快照按时间顺序重放。
2. **状态还原**: 在每个时间点，重构 `List[Market]` 对象。
3. **策略注入**: 将还原的市场数据注入 `ArbitrageScanner`，执行完全相同的策略逻辑。
4. **绩效评估**: 统计策略在历史数据上的 发现率、最大回撤、平均存续时间。

## 16.3 真实执行与签名 (The Executor)

> ⚠️ **安全警告**: 私钥仅在内存中通过环境变量加载，严禁写入磁盘。

### 签名机制 (EIP-712)
Polymarket CLOB API 要求对每个订单进行 EIP-712 签名。

**流程**:
1. **构建 Order 结构体**: 包含 Token ID, Price, Size, Side, Nonce 等。
2. **计算 Domain Separator**: 标识 Polymarket 合约域。
3. **私钥签名**: 使用 `eth_account` 对结构化数据进行签名。
4. **提交 API**: 发送包含签名的 POST 请求到 `/order` 端点。

### 安全熔断 (Kill Switch)
- **单笔限额**: 任何单笔交易不得超过 $100 (可配置)。
- **日亏损限额**: 当日累计亏损 > 5% 时自动停止。
- **干运行 (Dry Run)**: 默认开启，仅在显式确认后才发送真实签名。
